# ç‰¹å¾æ•°æ®å­˜å‚¨è¯´æ˜

## ğŸ“Š å­˜å‚¨ç­–ç•¥

é‡‡ç”¨**å®Œå…¨å­˜å‚¨æ‰€æœ‰ç‰¹å¾æ•°æ®**çš„æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… `cleaned_content` - æ¸…æ´—åçš„é¢˜ç›®å†…å®¹
2. âœ… `content_hash` - å†…å®¹å“ˆå¸Œå€¼ï¼ˆMD5ï¼‰
3. âœ… `ngram_json` - N-gramç‰¹å¾ï¼ˆJSONæ•°ç»„æ ¼å¼ï¼‰
4. âœ… `minhash_json` - MinHashæŒ‡çº¹ï¼ˆJSONæ•°ç»„æ ¼å¼ï¼Œ128ä¸ªæ•´æ•°ï¼‰

## ğŸ“‹ æ•°æ®åº“è¡¨

### è¡¨åï¼š`question_dedup_features`

**ç”¨é€”**ï¼šå­˜å‚¨æ¯ä¸ªé¢˜ç›®çš„æ‰€æœ‰ç‰¹å¾æ•°æ®ï¼Œæ”¯æŒç‰¹å¾æ•°æ®å¤ç”¨å’Œæ•°æ®åˆ†æã€‚

### è¡¨ç»“æ„

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | INT | è®°å½•IDï¼ˆä¸»é”®ï¼‰ | PRIMARY KEY |
| task_id | INT | ä»»åŠ¡IDï¼ˆå¤–é”®ï¼‰ | âœ… |
| question_id | INT | é¢˜ç›®ID | âœ… |
| cleaned_content | TEXT | æ¸…æ´—åçš„é¢˜ç›®å†…å®¹ | |
| content_hash | VARCHAR(32) | å†…å®¹å“ˆå¸Œå€¼ï¼ˆMD5ï¼‰ | âœ… |
| ngram_json | TEXT | N-gramç‰¹å¾ï¼ˆJSONæ•°ç»„æ ¼å¼ï¼‰ | |
| minhash_json | TEXT | MinHashæŒ‡çº¹ï¼ˆJSONæ•°ç»„æ ¼å¼ï¼‰ | |
| group_type | VARCHAR(2) | é¢˜å‹ | âœ… |
| group_subject_id | INT | ç§‘ç›®ID | âœ… |
| group_channel_code | VARCHAR(20) | æ¸ é“ä»£ç  | âœ… |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ | |

**å”¯ä¸€çº¦æŸ**ï¼š`(task_id, question_id)` - æ¯ä¸ªä»»åŠ¡ä¸­æ¯ä¸ªé¢˜ç›®åªæœ‰ä¸€æ¡ç‰¹å¾è®°å½•

**å¤–é”®çº¦æŸ**ï¼š`task_id` â†’ `dedup_tasks.id` (CASCADE DELETE)

### ç´¢å¼•è¯´æ˜

- `idx_task_id` - æŒ‰ä»»åŠ¡æŸ¥è¯¢
- `idx_question_id` - æŒ‰é¢˜ç›®æŸ¥è¯¢
- `idx_content_hash` - æŒ‰å“ˆå¸Œå€¼æŸ¥è¯¢ï¼ˆç”¨äºå¤ç”¨åˆ¤æ–­ï¼‰
- `idx_group` - æŒ‰åˆ†ç»„æŸ¥è¯¢

## ğŸ’¾ æ•°æ®æ ¼å¼è¯´æ˜

### cleaned_content (TEXT)
æ¸…æ´—åçš„é¢˜ç›®å†…å®¹ï¼Œçº¯æ–‡æœ¬æ ¼å¼ã€‚

ç¤ºä¾‹ï¼š
```
"å¦‚ä½•æ¯”è¾ƒé¢˜åº“ä¸­é¢˜ç›®çš„é‡å¤æ€§ï¼Ÿ"
```

### content_hash (VARCHAR(32))
MD5å“ˆå¸Œå€¼ï¼Œ32ä¸ªå­—ç¬¦çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ã€‚

ç¤ºä¾‹ï¼š
```
"5d41402abc4b2a76b9719d911017c592"
```

### ngram_json (TEXT)
N-gramç‰¹å¾çš„JSONæ•°ç»„æ ¼å¼ã€‚3-gramç¤ºä¾‹ï¼š

```json
["å¦‚ä½•æ¯”", "ä½•æ¯”è¾ƒ", "è¾ƒé¢˜åº“", "é¢˜åº“ä¸­", "åº“ä¸­é¢˜", "ä¸­é¢˜ç›®", "é¢˜ç›®çš„", "ç›®çš„é‡", "çš„é‡å¤", "é‡å¤æ€§"]
```

### minhash_json (TEXT)
MinHashæŒ‡çº¹çš„JSONæ•°ç»„æ ¼å¼ï¼ŒåŒ…å«128ä¸ªæ•´æ•°ï¼š

```json
[12345, 67890, 23456, 78901, ...]
```

## ğŸ”„ å¤ç”¨é€»è¾‘

ç¬¬äºŒæ¬¡ç­›æŸ¥æ—¶ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¤ç”¨ç‰¹å¾æ•°æ®ï¼š

```python
# 1. æŸ¥è¯¢æ˜¯å¦æœ‰è¯¥é¢˜ç›®çš„ç‰¹å¾è®°å½•
feature = QuestionDedupFeature.query.filter_by(
    question_id=question_id,
    task_id=previous_task_id  # æŸ¥è¯¢ä¹‹å‰ä»»åŠ¡çš„ç‰¹å¾
).first()

if feature:
    # 2. è®¡ç®—å½“å‰å†…å®¹çš„å“ˆå¸Œå€¼
    current_hash = md5(clean_content(current_content))
    
    # 3. æ¯”è¾ƒå“ˆå¸Œå€¼
    if feature.content_hash == current_hash:
        # å†…å®¹æ²¡å˜ï¼Œç›´æ¥å¤ç”¨æ‰€æœ‰ç‰¹å¾æ•°æ®
        cleaned_content = feature.cleaned_content
        ngrams = feature.get_ngrams()
        minhash = feature.get_minhash()
    else:
        # å†…å®¹å˜åŒ–ï¼Œéœ€è¦é‡æ–°è®¡ç®—
        cleaned_content, ngrams, minhash = compute_features(current_content)
else:
    # æ²¡æœ‰è®°å½•ï¼Œéœ€è¦é‡æ–°è®¡ç®—
    cleaned_content, ngrams, minhash = compute_features(current_content)
```

## ğŸ“ˆ å­˜å‚¨ç©ºé—´ä¼°ç®—

å‡è®¾50ä¸‡é¢˜ç›®ï¼š

| å­—æ®µ | å¹³å‡å¤§å° | ä¼°ç®— |
|------|---------|------|
| cleaned_content | 200å­—èŠ‚ | 100MB |
| content_hash | 32å­—èŠ‚ | 16MB |
| ngram_json | 2KB | 1GB |
| minhash_json | 1KB | 500MB |
| å…¶ä»–å­—æ®µ | 50å­—èŠ‚ | 25MB |
| **æ€»è®¡** | **çº¦3.5KB/é¢˜** | **çº¦1.7GB** |

**æ³¨æ„**ï¼šå®é™…å¤§å°å–å†³äºé¢˜ç›®å†…å®¹çš„é•¿åº¦å’Œå¤æ‚åº¦ã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®é‡**ï¼š50ä¸‡é¢˜ç›®çº¦éœ€è¦1.5-2GBå­˜å‚¨ç©ºé—´
2. **æ€§èƒ½**ï¼šå†™å…¥æ•°æ®åº“éœ€è¦æ—¶é—´ï¼Œå¯èƒ½å½±å“å¤„ç†é€Ÿåº¦
3. **å†…å®¹å˜åŒ–**ï¼šå¦‚æœé¢˜ç›®å†…å®¹ç»å¸¸å˜åŒ–ï¼Œå¤ç”¨æ•ˆæœä¼šé™ä½
4. **æ¸…ç†ç­–ç•¥**ï¼šå¯ä»¥è€ƒè™‘å®šæœŸæ¸…ç†æ—§ä»»åŠ¡çš„ç‰¹å¾æ•°æ®

## ğŸ”§ ä½¿ç”¨å»ºè®®

1. **æŸ¥è¯¢æ—¶æŒ‰task_idè¿‡æ»¤**ï¼šé¿å…æŸ¥è¯¢åˆ°å…¶ä»–ä»»åŠ¡çš„æ•°æ®
2. **ä½¿ç”¨ç´¢å¼•å­—æ®µæŸ¥è¯¢**ï¼šæé«˜æŸ¥è¯¢æ€§èƒ½
3. **æ‰¹é‡æ“ä½œ**ï¼šå¤„ç†å¤§é‡æ•°æ®æ—¶ä½¿ç”¨æ‰¹é‡æ’å…¥
4. **äº‹åŠ¡ç®¡ç†**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§

---

**æœ€åæ›´æ–°**ï¼š2026-01-03

