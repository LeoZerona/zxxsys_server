# 题目去重任务字段更新说明

## 更新内容

为 `dedup_tasks` 表添加了两个新字段：

1. **analysis_type** (VARCHAR(50)): 分析类型
   - 默认值：`'full'`
   - 可选值：`'full'`（全量分析）、`'incremental'`（增量分析）、`'custom'`（自定义分析）
   - 说明：标识任务的分析类型

2. **estimated_duration** (INT): 预估时长（秒）
   - 默认值：`NULL`
   - 说明：系统根据题目数量和分组数自动计算的预估处理时长

## 数据库迁移步骤

### MySQL 数据库

1. **执行迁移SQL脚本**：

```bash
# 方式1：使用 MySQL 命令行
mysql -u root -p your_database < sql/add_dedup_task_fields.sql

# 方式2：在 MySQL 客户端中执行
source sql/add_dedup_task_fields.sql;
```

2. **或者手动执行SQL**：

```sql
-- 添加 analysis_type 字段
ALTER TABLE dedup_tasks 
ADD COLUMN analysis_type VARCHAR(50) DEFAULT 'full' 
COMMENT '分析类型：full=全量分析, incremental=增量分析, custom=自定义分析' 
AFTER config_json;

-- 添加 estimated_duration 字段
ALTER TABLE dedup_tasks 
ADD COLUMN estimated_duration INT 
COMMENT '预估时长（秒）' 
AFTER analysis_type;
```

3. **验证字段是否添加成功**：

```sql
-- 查看表结构
DESC dedup_tasks;

-- 或查询字段信息
SELECT COLUMN_NAME, DATA_TYPE, COLUMN_DEFAULT, COLUMN_COMMENT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = DATABASE()
  AND TABLE_NAME = 'dedup_tasks'
  AND COLUMN_NAME IN ('analysis_type', 'estimated_duration');
```

### SQLite 数据库

```sql
-- 添加 analysis_type 字段
ALTER TABLE dedup_tasks 
ADD COLUMN analysis_type VARCHAR(50) DEFAULT 'full';

-- 添加 estimated_duration 字段
ALTER TABLE dedup_tasks 
ADD COLUMN estimated_duration INTEGER;
```

## 接口变更说明

### 创建任务接口 (`POST /api/dedup/tasks`)

**新增请求参数**：
- `analysis_type` (可选): 分析类型，默认 `'full'`

**响应数据新增字段**：
- `analysis_type`: 分析类型
- `estimated_duration`: 预估时长（秒）

**示例请求**：

```json
{
  "task_name": "我的去重任务",
  "analysis_type": "full",
  "config": {
    "similarity_threshold": 0.85
  }
}
```

**示例响应**：

```json
{
  "success": true,
  "message": "任务创建成功",
  "data": {
    "id": 1,
    "task_name": "我的去重任务",
    "status": "pending",
    "total_groups": 150,
    "total_questions": 2500,
    "analysis_type": "full",
    "estimated_duration": 550,
    ...
  }
}
```

## 预估时长计算规则

系统会根据以下规则自动计算预估时长：

```
预估时长（秒）= 30 + (总题目数 × 0.1) + (总分组数 × 5)
```

说明：
- **基础开销**：30秒（任务初始化、数据库连接等）
- **题目处理时间**：每个题目 0.1秒（包括清洗、特征提取、相似度计算等）
- **分组处理时间**：每个分组 5秒（分组初始化、数据加载等）

## 前端对接说明

1. **存储返回数据**：前端需要将接口返回的以下字段存储到数据库：
   - `analysis_type`: 分析类型
   - `total_questions`: 题目数量
   - `estimated_duration`: 预估时长

2. **显示预估时长**：可以在任务列表中显示预估时长，帮助用户了解任务的处理时间

3. **分析类型选择**：创建任务时可以让用户选择分析类型：
   - `full`: 全量分析（分析所有题目）
   - `incremental`: 增量分析（只分析新增题目）
   - `custom`: 自定义分析（按条件筛选）

## 注意事项

1. **向后兼容**：如果表中已有数据，新字段会使用默认值（`analysis_type='full'`, `estimated_duration=NULL`）

2. **数据迁移**：对于已存在的任务记录，如果需要更新 `estimated_duration`，可以：
   - 重新创建任务（推荐）
   - 或手动更新数据库记录

3. **字段验证**：创建任务时，如果传入的 `analysis_type` 不是有效值，接口会返回错误

## 回滚方案（如果需要）

如果需要回滚这些更改，可以执行以下SQL：

```sql
-- MySQL
ALTER TABLE dedup_tasks DROP COLUMN estimated_duration;
ALTER TABLE dedup_tasks DROP COLUMN analysis_type;

-- SQLite
-- SQLite 不支持 DROP COLUMN，需要重建表
```

