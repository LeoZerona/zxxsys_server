# é‡å»º users è¡¨è¯´æ˜

## ğŸ“‹ è¯´æ˜

æœ¬æ“ä½œå°†**åˆ é™¤å¹¶é‡å»º users è¡¨**ï¼Œç¡®ä¿è¡¨åŒ…å«æœ€æ–°çš„ `role` æƒé™å­—æ®µã€‚

âš ï¸ **æ³¨æ„**ï¼šæ­¤æ“ä½œ**ä»…å½±å“ users è¡¨**ï¼Œä¸ä¼šå½±å“å…¶ä»–è¡¨ï¼ˆå¦‚ `email_verifications`ï¼‰ã€‚

---

## ğŸš€ æ–¹å¼ä¸€ï¼šä½¿ç”¨ç®€åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

### æ‰§è¡Œæ­¥éª¤

```bash
python rebuild_users_table_simple.py
```

### ç‰¹ç‚¹
- âœ… ä½¿ç”¨ SQLAlchemyï¼Œè‡ªåŠ¨é€‚é…æ•°æ®åº“ç±»å‹
- âœ… æ ¹æ® `models.py` è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„
- âœ… ä»£ç ç®€æ´ï¼Œæ˜“äºç»´æŠ¤

---

## ğŸ”§ æ–¹å¼äºŒï¼šä½¿ç”¨å®Œæ•´è„šæœ¬

### æ‰§è¡Œæ­¥éª¤

```bash
python rebuild_users_table.py
```

### ç‰¹ç‚¹
- âœ… ç›´æ¥æ‰§è¡Œ SQLï¼Œæ›´åº•å±‚
- âœ… æ”¯æŒè‡ªå®šä¹‰è¡¨ç»“æ„
- âœ… è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—

---

## ğŸ“Š é‡å»ºåçš„è¡¨ç»“æ„

### users è¡¨å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|--------|------|------|------|
| id | INTEGER/INT/SERIAL | ä¸»é”® | PRIMARY KEY, AUTO_INCREMENT |
| email | VARCHAR(120) | é‚®ç®±åœ°å€ | UNIQUE, NOT NULL, å·²å»ºç´¢å¼• |
| password_hash | VARCHAR(255) | å¯†ç å“ˆå¸Œ | NOT NULL |
| **role** | VARCHAR(20) | ç”¨æˆ·æƒé™ | NOT NULL, DEFAULT 'user', å·²å»ºç´¢å¼• |
| created_at | DATETIME/TIMESTAMP | åˆ›å»ºæ—¶é—´ | DEFAULT CURRENT_TIMESTAMP |
| updated_at | DATETIME/TIMESTAMP | æ›´æ–°æ—¶é—´ | DEFAULT CURRENT_TIMESTAMP |
| is_active | BOOLEAN/TINYINT(1) | æ˜¯å¦æ¿€æ´» | DEFAULT 1/TRUE |

### role å­—æ®µè¯´æ˜

- **é»˜è®¤å€¼**ï¼š`'user'`
- **å…è®¸å€¼**ï¼š
  - `'super_admin'` - è¶…çº§ç®¡ç†å‘˜
  - `'admin'` - ç®¡ç†å‘˜
  - `'user'` - æ™®é€šç”¨æˆ·ï¼ˆé»˜è®¤ï¼‰

---

## âœ… éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨

**SQLite**:
```bash
sqlite3 app.db ".tables"
```

**MySQL**:
```sql
SHOW TABLES;
```

**PostgreSQL**:
```sql
\dt
```

### 2. æŸ¥çœ‹è¡¨ç»“æ„

**SQLite**:
```bash
sqlite3 app.db ".schema users"
```

**MySQL**:
```sql
DESCRIBE users;
```

**PostgreSQL**:
```sql
\d users
```

### 3. éªŒè¯ role å­—æ®µ

```sql
-- æŸ¥çœ‹è¡¨ç»“æ„ä¸­çš„ role å­—æ®µ
SELECT * FROM users LIMIT 0;  -- æŸ¥çœ‹å­—æ®µ
```

### 4. æµ‹è¯•æ’å…¥æ•°æ®

```python
from app import app, db
from models import User

with app.app_context():
    # åˆ›å»ºæµ‹è¯•ç”¨æˆ·
    test_user = User(
        email='test@example.com',
        role='user'
    )
    test_user.set_password('test123')
    
    db.session.add(test_user)
    db.session.commit()
    
    # éªŒè¯
    user = User.query.filter_by(email='test@example.com').first()
    print(f"ç”¨æˆ·: {user.email}")
    print(f"æƒé™: {user.role}")  # åº”è¯¥æ˜¾ç¤º 'user'
```

---

## ğŸ” ä¸å…¶ä»–è¡¨çš„å…³è”

### email_verifications è¡¨

âœ… **ä¸å—å½±å“** - `email_verifications` è¡¨å®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¼šè¢«åˆ é™¤æˆ–ä¿®æ”¹ã€‚

### æ•°æ®å…³ç³»

- `email_verifications.email` ä¸ `users.email` æ˜¯é€»è¾‘å…³è”ï¼ˆä¸æ˜¯å¤–é”®ï¼‰
- é‡å»º users è¡¨ä¸ä¼šå½±å“éªŒè¯ç è®°å½•
- ç”¨æˆ·æ³¨å†Œåï¼ŒéªŒè¯ç ä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å¤‡ä»½**
   - è™½ç„¶ users è¡¨æ˜¯ç©ºè¡¨ï¼Œä½†å»ºè®®åœ¨æ‰§è¡Œå‰ç¡®è®¤
   - å¦‚æœæœ‰æ•°æ®ï¼Œè¯·å…ˆå¤‡ä»½

2. **å…¶ä»–è¡¨ä¿æŠ¤**
   - âœ… `email_verifications` è¡¨ä¸ä¼šè¢«å½±å“
   - âœ… å…¶ä»–ä»»ä½•è¡¨éƒ½ä¸ä¼šè¢«å½±å“

3. **ç´¢å¼•åˆ›å»º**
   - é‡å»ºåä¼šè‡ªåŠ¨åˆ›å»ºä»¥ä¸‹ç´¢å¼•ï¼š
     - `idx_users_email` - é‚®ç®±ç´¢å¼•
     - `idx_users_role` - æƒé™ç´¢å¼•

4. **é»˜è®¤å€¼**
   - æ–°åˆ›å»ºçš„ users è¡¨ä¸­ï¼Œ`role` å­—æ®µé»˜è®¤å€¼ä¸º `'user'`

---

## ğŸ“ æ‰§è¡Œç¤ºä¾‹

### æˆåŠŸæ‰§è¡Œç¤ºä¾‹

```
============================================================
é‡å»º users è¡¨ï¼ˆSQLAlchemy æ–¹å¼ï¼‰
============================================================

âš ï¸  æ£€æµ‹åˆ° users è¡¨å­˜åœ¨ï¼Œæ­£åœ¨åˆ é™¤...
âœ… users è¡¨å·²åˆ é™¤

æ­£åœ¨åˆ›å»ºæ–°çš„ users è¡¨...
âœ… users è¡¨åˆ›å»ºæˆåŠŸ

è¡¨ç»“æ„éªŒè¯:
  - id: INTEGER
  - email: VARCHAR(120)
  - password_hash: VARCHAR(255)
  - role: VARCHAR(20)
  - created_at: DATETIME
  - updated_at: DATETIME
  - is_active: BOOLEAN

============================================================
âœ… é‡å»ºå®Œæˆï¼
============================================================

æ³¨æ„ï¼š
- role å­—æ®µé»˜è®¤å€¼ä¸º 'user'
- email å’Œ role å­—æ®µå·²å»ºç«‹ç´¢å¼•
```

---

## ğŸ”„ å¦‚æœéœ€è¦ä¿ç•™æ•°æ®

å¦‚æœ users è¡¨æœ‰æ•°æ®éœ€è¦ä¿ç•™ï¼Œè¯·ä½¿ç”¨è¿ç§»è„šæœ¬è€Œä¸æ˜¯é‡å»ºï¼š

```bash
# ä½¿ç”¨è¿ç§»è„šæœ¬æ·»åŠ  role å­—æ®µï¼ˆä¿ç•™æ•°æ®ï¼‰
python migrate_add_user_role.py
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `rebuild_users_table_simple.py` - ç®€åŒ–ç‰ˆé‡å»ºè„šæœ¬ï¼ˆæ¨èï¼‰
- `rebuild_users_table.py` - å®Œæ•´ç‰ˆé‡å»ºè„šæœ¬
- `models.py` - ç”¨æˆ·æ¨¡å‹å®šä¹‰
- `update_users_table_add_role.sql` - è¿ç§» SQLï¼ˆä¿ç•™æ•°æ®æ—¶ä½¿ç”¨ï¼‰

---

**å»ºè®®ä½¿ç”¨ `rebuild_users_table_simple.py`ï¼Œæ“ä½œæ›´ç®€å•ï¼** ğŸš€

