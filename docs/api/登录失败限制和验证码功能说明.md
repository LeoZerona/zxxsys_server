# ç™»å½•å¤±è´¥é™åˆ¶å’ŒéªŒè¯ç åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä¸ºäº†é˜²æ­¢æš´åŠ›ç ´è§£æ”»å‡»ï¼Œç³»ç»Ÿå®ç°äº†ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶æœºåˆ¶ï¼š
- **é™åˆ¶è§„åˆ™**ï¼šåŒä¸€ä¸ªç”¨æˆ·åœ¨ **10 åˆ†é’Ÿå†…è¿ç»­ç™»å½•å¤±è´¥ 10 æ¬¡**åï¼Œéœ€è¦è¾“å…¥éªŒè¯ç æ‰èƒ½ç»§ç»­ç™»å½•
- **éªŒè¯ç æœ‰æ•ˆæœŸ**ï¼šéªŒè¯ç æœ‰æ•ˆæœŸä¸º **5 åˆ†é’Ÿ**
- **è‡ªåŠ¨é‡ç½®**ï¼šç™»å½•æˆåŠŸåï¼Œå¤±è´¥è®°å½•ä¼šè‡ªåŠ¨æ¸…é™¤

---

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

å¯ä»¥åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å‚æ•°ï¼š

```env
# ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶ï¼ˆé»˜è®¤ï¼š10æ¬¡ï¼‰
LOGIN_FAIL_LIMIT=10

# æ—¶é—´çª—å£ï¼ˆåˆ†é’Ÿï¼Œé»˜è®¤ï¼š10åˆ†é’Ÿï¼‰
LOGIN_FAIL_WINDOW_MINUTES=10
```

---

## ğŸ“¡ API æ¥å£

### 1. è·å–éªŒè¯ç 

**æ¥å£åœ°å€**: `GET /api/captcha`

**è¯·æ±‚å¤´**: æ— ç‰¹æ®Šè¦æ±‚

**è¯·æ±‚å‚æ•°**: æ— 

**æˆåŠŸå“åº”** (200):
```json
{
  "success": true,
  "message": "éªŒè¯ç ç”ŸæˆæˆåŠŸ",
  "data": {
    "captcha_code": "1234",
    "session_key": "a1b2c3d4e5f6g7h8",
    "expires_in": 300
  }
}
```

**å“åº”å­—æ®µè¯´æ˜**:
- `captcha_code`: éªŒè¯ç ï¼ˆ4ä½æ•°å­—ï¼‰ï¼Œç”¨äºå‰ç«¯æ˜¾ç¤º
- `session_key`: ä¼šè¯é”®ï¼Œç”¨äºéªŒè¯æ—¶æ ‡è¯†éªŒè¯ç 
- `expires_in`: éªŒè¯ç æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 300 ç§’ï¼ˆ5åˆ†é’Ÿï¼‰

**é”™è¯¯å“åº”**: æ— ï¼ˆæ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šå¤±è´¥ï¼‰

---

### 2. ç”¨æˆ·ç™»å½•ï¼ˆæ”¯æŒéªŒè¯ç ï¼‰

**æ¥å£åœ°å€**: `POST /api/login`

**è¯·æ±‚å¤´**:
```
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**:
```json
{
  "email": "user@example.com",
  "password": "password123",
  "captcha_session_key": "a1b2c3d4e5f6g7h8",  // å¯é€‰ï¼Œå½“éœ€è¦éªŒè¯ç æ—¶å¿…éœ€
  "captcha_code": "1234"  // å¯é€‰ï¼Œå½“éœ€è¦éªŒè¯ç æ—¶å¿…éœ€
}
```

**æˆåŠŸå“åº”** (200):
```json
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "role": "user",
      "created_at": "2024-01-01T00:00:00",
      "is_active": true
    },
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "Bearer",
    "expires_in": 1800
  }
}
```

**éœ€è¦éªŒè¯ç æ—¶çš„é”™è¯¯å“åº”** (400):
```json
{
  "success": false,
  "message": "ç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè¯·è¾“å…¥éªŒè¯ç ",
  "code": "REQUIRES_CAPTCHA",
  "requires_captcha": true,
  "attempt_count": 10
}
```

**éªŒè¯ç é”™è¯¯æ—¶çš„å“åº”** (400):
```json
{
  "success": false,
  "message": "éªŒè¯ç é”™è¯¯",
  "code": "INVALID_CAPTCHA",
  "requires_captcha": true
}
```

---

## ğŸ”„ ç™»å½•æµç¨‹

### æ­£å¸¸ç™»å½•æµç¨‹

```
1. ç”¨æˆ·è¾“å…¥é‚®ç®±å’Œå¯†ç 
2. å‰ç«¯è°ƒç”¨ POST /api/login
3. åç«¯éªŒè¯é‚®ç®±å’Œå¯†ç 
4. éªŒè¯æˆåŠŸ â†’ è¿”å› Token å’Œç”¨æˆ·ä¿¡æ¯
5. éªŒè¯å¤±è´¥ â†’ è®°å½•å¤±è´¥æ¬¡æ•°ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
```

### éœ€è¦éªŒè¯ç çš„ç™»å½•æµç¨‹

```
1. ç”¨æˆ·è¾“å…¥é‚®ç®±å’Œå¯†ç ï¼ˆå‰ 10 æ¬¡å¤±è´¥ï¼‰
2. ç¬¬ 11 æ¬¡å¤±è´¥æ—¶ï¼Œåç«¯è¿”å› requires_captcha: true
3. å‰ç«¯è°ƒç”¨ GET /api/captcha è·å–éªŒè¯ç 
4. å‰ç«¯æ˜¾ç¤ºéªŒè¯ç ï¼Œç”¨æˆ·è¾“å…¥éªŒè¯ç 
5. å‰ç«¯å†æ¬¡è°ƒç”¨ POST /api/loginï¼Œæºå¸¦éªŒè¯ç 
6. åç«¯éªŒè¯éªŒè¯ç å’Œç™»å½•ä¿¡æ¯
7. å…¨éƒ¨éªŒè¯é€šè¿‡ â†’ ç™»å½•æˆåŠŸï¼Œæ¸…é™¤å¤±è´¥è®°å½•
```

---

## ğŸ’» å‰ç«¯å®ç°ç¤ºä¾‹

### Vue3 + TypeScript ç¤ºä¾‹

```typescript
// api/auth.ts
interface LoginRequest {
  email: string
  password: string
  captcha_session_key?: string
  captcha_code?: string
}

interface LoginResponse {
  success: boolean
  message: string
  code?: string
  requires_captcha?: boolean
  attempt_count?: number
  data?: {
    user: any
    access_token: string
    refresh_token: string
    token_type: string
    expires_in: number
  }
}

interface CaptchaResponse {
  success: boolean
  message: string
  data: {
    captcha_code: string
    session_key: string
    expires_in: number
  }
}

// è·å–éªŒè¯ç 
export async function getCaptcha(): Promise<CaptchaResponse> {
  const response = await fetch('http://localhost:5000/api/captcha', {
    method: 'GET',
  })
  return response.json()
}

// ç”¨æˆ·ç™»å½•
export async function login(
  email: string,
  password: string,
  captchaSessionKey?: string,
  captchaCode?: string
): Promise<LoginResponse> {
  const requestBody: LoginRequest = {
    email,
    password,
  }
  
  if (captchaSessionKey && captchaCode) {
    requestBody.captcha_session_key = captchaSessionKey
    requestBody.captcha_code = captchaCode
  }
  
  const response = await fetch('http://localhost:5000/api/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(requestBody),
  })
  
  return response.json()
}
```

### Vue ç»„ä»¶ç¤ºä¾‹

```vue
<template>
  <div class="login-form">
    <h2>ç”¨æˆ·ç™»å½•</h2>
    
    <el-form :model="form" :rules="rules" ref="formRef" label-width="100px">
      <el-form-item label="é‚®ç®±" prop="email">
        <el-input v-model="form.email" placeholder="è¯·è¾“å…¥é‚®ç®±" />
      </el-form-item>
      
      <el-form-item label="å¯†ç " prop="password">
        <el-input 
          v-model="form.password" 
          type="password" 
          placeholder="è¯·è¾“å…¥å¯†ç "
          show-password
        />
      </el-form-item>
      
      <!-- éªŒè¯ç è¾“å…¥æ¡†ï¼ˆä»…åœ¨éœ€è¦æ—¶æ˜¾ç¤ºï¼‰ -->
      <el-form-item 
        v-if="requiresCaptcha" 
        label="éªŒè¯ç " 
        prop="captchaCode"
      >
        <div style="display: flex; gap: 10px; align-items: center;">
          <el-input 
            v-model="form.captchaCode" 
            placeholder="è¯·è¾“å…¥éªŒè¯ç "
            style="flex: 1;"
          />
          <div 
            class="captcha-display"
            style="
              width: 100px;
              height: 40px;
              background: #f5f5f5;
              border: 1px solid #ddd;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 20px;
              font-weight: bold;
              letter-spacing: 5px;
              cursor: pointer;
            "
            @click="refreshCaptcha"
          >
            {{ captchaCode }}
          </div>
        </div>
        <div style="margin-top: 5px; color: #909399; font-size: 12px;">
          ç‚¹å‡»éªŒè¯ç å¯åˆ·æ–°
        </div>
      </el-form-item>
      
      <el-form-item>
        <el-button type="primary" :loading="loading" @click="handleLogin">
          ç™»å½•
        </el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue'
import { ElMessage } from 'element-plus'
import { login, getCaptcha } from '@/api/auth'

const form = reactive({
  email: '',
  password: '',
  captchaCode: '',
})

const requiresCaptcha = ref(false)
const captchaCode = ref('')
const captchaSessionKey = ref('')
const loading = ref(false)
const formRef = ref()

const rules = {
  email: [
    { required: true, message: 'è¯·è¾“å…¥é‚®ç®±', trigger: 'blur' },
    { type: 'email', message: 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼', trigger: 'blur' },
  ],
  password: [
    { required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur' },
  ],
  captchaCode: [
    { required: true, message: 'è¯·è¾“å…¥éªŒè¯ç ', trigger: 'blur' },
    { len: 4, message: 'éªŒè¯ç é•¿åº¦ä¸º4ä½', trigger: 'blur' },
  ],
}

// è·å–éªŒè¯ç 
const refreshCaptcha = async () => {
  try {
    const response = await getCaptcha()
    if (response.success) {
      captchaCode.value = response.data.captcha_code
      captchaSessionKey.value = response.data.session_key
      ElMessage.success('éªŒè¯ç å·²åˆ·æ–°')
    }
  } catch (error) {
    ElMessage.error('è·å–éªŒè¯ç å¤±è´¥')
  }
}

// å¤„ç†ç™»å½•
const handleLogin = async () => {
  try {
    await formRef.value?.validate()
  } catch {
    return
  }

  loading.value = true

  try {
    const response = await login(
      form.email,
      form.password,
      requiresCaptcha.value ? captchaSessionKey.value : undefined,
      requiresCaptcha.value ? form.captchaCode : undefined
    )

    if (response.success) {
      ElMessage.success('ç™»å½•æˆåŠŸï¼')
      // ä¿å­˜ Token
      localStorage.setItem('access_token', response.data!.access_token)
      localStorage.setItem('refresh_token', response.data!.refresh_token)
      // è·³è½¬åˆ°é¦–é¡µæˆ–å…¶ä»–é¡µé¢
      // router.push('/')
    } else {
      // æ£€æŸ¥æ˜¯å¦éœ€è¦éªŒè¯ç 
      if (response.code === 'REQUIRES_CAPTCHA') {
        requiresCaptcha.value = true
        // è‡ªåŠ¨è·å–éªŒè¯ç 
        await refreshCaptcha()
        ElMessage.warning('ç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè¯·è¾“å…¥éªŒè¯ç ')
      } else {
        ElMessage.error(response.message || 'ç™»å½•å¤±è´¥')
        // å¦‚æœä¹‹å‰éœ€è¦éªŒè¯ç ä½†ç°åœ¨ä¸éœ€è¦äº†ï¼Œæ¸…é™¤éªŒè¯ç è¾“å…¥
        if (response.code !== 'INVALID_CAPTCHA') {
          requiresCaptcha.value = false
          form.captchaCode = ''
        }
      }
    }
  } catch (error: any) {
    ElMessage.error(error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    loading.value = false
  }
}
</script>
```

---

## ğŸ—„ï¸ æ•°æ®åº“è¡¨ç»“æ„

### login_attempts è¡¨

ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»º `login_attempts` è¡¨æ¥è®°å½•ç™»å½•å¤±è´¥å°è¯•ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | INTEGER | ä¸»é”® |
| email | VARCHAR(120) | ç”¨æˆ·é‚®ç®±ï¼ˆç´¢å¼•ï¼‰ |
| ip_address | VARCHAR(45) | IPåœ°å€ï¼ˆç´¢å¼•ï¼‰ |
| attempt_count | INTEGER | å¤±è´¥æ¬¡æ•° |
| first_attempt_at | DATETIME | é¦–æ¬¡å°è¯•æ—¶é—´ |
| last_attempt_at | DATETIME | æœ€åå°è¯•æ—¶é—´ |
| requires_captcha | BOOLEAN | æ˜¯å¦éœ€è¦éªŒè¯ç  |
| captcha_verified | BOOLEAN | éªŒè¯ç æ˜¯å¦å·²éªŒè¯ |

**æ³¨æ„äº‹é¡¹**:
- ç™»å½•æˆåŠŸåï¼Œè¯¥ç”¨æˆ·çš„å¤±è´¥è®°å½•ä¼šè¢«è‡ªåŠ¨åˆ é™¤
- è¶…è¿‡æ—¶é—´çª—å£ï¼ˆé»˜è®¤10åˆ†é’Ÿï¼‰çš„è®°å½•ä¼šåœ¨ä¸‹æ¬¡å°è¯•æ—¶è‡ªåŠ¨é‡ç½®
- ç³»ç»Ÿä½¿ç”¨é‚®ç®±ä½œä¸ºæ ‡è¯†ï¼Œä¸åŒIPçš„ç›¸åŒé‚®ç®±ä¼šç´¯è®¡å¤±è´¥æ¬¡æ•°

---

## ğŸ”’ å®‰å…¨è¯´æ˜

1. **é˜²æ­¢æš´åŠ›ç ´è§£**: é™åˆ¶åŒä¸€é‚®ç®±çš„ç™»å½•å¤±è´¥æ¬¡æ•°ï¼Œæœ‰æ•ˆé˜²æ­¢æš´åŠ›ç ´è§£æ”»å‡»

2. **éªŒè¯ç ä¿æŠ¤**: è¾¾åˆ°é™åˆ¶åè¦æ±‚éªŒè¯ç ï¼Œè¿›ä¸€æ­¥å¢åŠ æ”»å‡»éš¾åº¦

3. **æ—¶é—´çª—å£**: ä½¿ç”¨æ—¶é—´çª—å£æœºåˆ¶ï¼Œé¿å…æ°¸ä¹…é”å®šï¼ˆ10åˆ†é’Ÿåè‡ªåŠ¨é‡ç½®ï¼‰

4. **è‡ªåŠ¨æ¸…é™¤**: ç™»å½•æˆåŠŸåè‡ªåŠ¨æ¸…é™¤å¤±è´¥è®°å½•ï¼Œä¸å½±å“æ­£å¸¸ç”¨æˆ·

5. **IPè®°å½•**: è®°å½•IPåœ°å€ï¼Œä¾¿äºåç»­åˆ†æï¼ˆå¯é€‰åŠŸèƒ½æ‰©å±•ï¼‰

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **Session å­˜å‚¨**: éªŒè¯ç å­˜å‚¨åœ¨ Flask Session ä¸­ï¼Œéœ€è¦ç¡®ä¿ï¼š
   - å·²é…ç½® `SECRET_KEY`ï¼ˆå·²åœ¨ `config.py` ä¸­é…ç½®ï¼‰
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Redis ç­‰æŒä¹…åŒ–å­˜å‚¨

2. **è·¨åŸŸé—®é¢˜**: å¦‚æœå‰ç«¯å’Œåç«¯ä¸åœ¨åŒä¸€åŸŸåï¼Œéœ€è¦ç¡®ä¿ï¼š
   - CORS é…ç½®æ­£ç¡®
   - å¦‚æœä½¿ç”¨ Cookie Sessionï¼Œéœ€è¦è®¾ç½® `supports_credentials=True`

3. **éªŒè¯ç æ˜¾ç¤º**: å½“å‰è¿”å›çš„æ˜¯çº¯æ–‡æœ¬éªŒè¯ç ï¼Œå‰ç«¯å¯ä»¥ï¼š
   - ç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
   - ä½¿ç”¨å›¾å½¢åº“ç”Ÿæˆå›¾ç‰‡ï¼ˆæ¨èï¼‰
   - ä½¿ç”¨ç¬¬ä¸‰æ–¹éªŒè¯ç æœåŠ¡ï¼ˆå¦‚ Google reCAPTCHAï¼‰

---

## ğŸ§ª æµ‹è¯•å»ºè®®

1. **æ­£å¸¸ç™»å½•æµ‹è¯•**: ä½¿ç”¨æ­£ç¡®çš„é‚®ç®±å’Œå¯†ç ï¼Œåº”è¯¥ç›´æ¥ç™»å½•æˆåŠŸ

2. **å¤±è´¥æ¬¡æ•°æµ‹è¯•**: 
   - è¿ç»­ä½¿ç”¨é”™è¯¯å¯†ç ç™»å½• 10 æ¬¡
   - ç¬¬ 11 æ¬¡åº”è¯¥è¿”å› `requires_captcha: true`
   - è·å–éªŒè¯ç åï¼Œæºå¸¦éªŒè¯ç ç™»å½•åº”è¯¥æˆåŠŸ

3. **éªŒè¯ç è¿‡æœŸæµ‹è¯•**:
   - è·å–éªŒè¯ç åç­‰å¾… 5 åˆ†é’Ÿ
   - ä½¿ç”¨è¿‡æœŸçš„éªŒè¯ç ç™»å½•åº”è¯¥è¿”å›"éªŒè¯ç å·²è¿‡æœŸ"

4. **æ—¶é—´çª—å£æµ‹è¯•**:
   - å¤±è´¥ 10 æ¬¡åç­‰å¾… 10 åˆ†é’Ÿ
   - å†æ¬¡ç™»å½•ï¼ˆä¸å¸¦éªŒè¯ç ï¼‰åº”è¯¥å…è®¸å°è¯•ï¼ˆæ—¶é—´çª—å£å·²é‡ç½®ï¼‰

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ç™»å½•æ¥å£æ–‡æ¡£](./API.md)
- [èº«ä»½éªŒè¯ä¸­é—´ä»¶è¯´æ˜](../èº«ä»½éªŒè¯ä¸­é—´ä»¶ä½¿ç”¨è¯´æ˜.md)

