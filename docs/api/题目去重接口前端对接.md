## 前端调用示例

本节提供所有接口的调用示例，包括请求参数和响应数据的说明。

### 1. 获取任务列表

**请求示例**:

```http
GET /api/dedup/tasks?page=1&page_size=20&status=running
```

**请求参数**:

- `page`: 1 (页码)
- `page_size`: 20 (每页数量)
- `status`: "running" (可选，状态筛选)

**响应数据**:

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "list": [
      {
        "id": 1,
        "task_name": "查找重复题目-20240101_120000",
        "status": "running",
        "total_groups": 150,
        "processed_groups": 75,
        "total_questions": 2500,
        "exact_duplicate_groups": 2,
        "exact_duplicate_pairs": 5,
        "similar_duplicate_pairs": 3,
        "progress_percentage": 50.0,
        "analysis_type": "full",
        "estimated_duration": 550,
        "started_at": "2024-01-01T12:00:00",
        "completed_at": null,
        "created_at": "2024-01-01T12:00:00",
        "updated_at": "2024-01-01T12:15:00"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 10,
      "total_pages": 1
    }
  }
}
```

---

### 2. 创建新任务

**请求示例**:

```http
POST /api/dedup/tasks
Content-Type: application/json

{
  "task_name": "我的去重任务",
  "analysis_type": "full",
  "config": {
    "similarity_threshold": 0.85
  }
}
```

**请求参数**:

- `task_name`: "我的去重任务" (可选，不提供则自动生成)
- `analysis_type`: "full" (可选，分析类型，默认 "full")
  - `full`: 全量分析（分析所有题目）
  - `incremental`: 增量分析（只分析新增题目）
  - `custom`: 自定义分析（按条件筛选）
- `config`: 对象 (可选)
  - `similarity_threshold`: 0.85 (可选，相似度阈值，默认 0.8)

**响应数据**:

```json
{
  "success": true,
  "message": "任务创建成功",
  "data": {
    "id": 1,
    "task_name": "我的去重任务",
    "status": "pending",
    "total_groups": 150,
    "processed_groups": 0,
    "total_questions": 2500,
    "exact_duplicate_groups": 0,
    "exact_duplicate_pairs": 0,
    "similar_duplicate_pairs": 0,
    "progress_percentage": 0.0,
    "analysis_type": "full",
    "estimated_duration": 550,
    "config": {
      "similarity_threshold": 0.85
    },
    "created_at": "2024-01-01T12:00:00",
    "updated_at": "2024-01-01T12:00:00"
  }
}
```

**响应字段说明**:

- `id`: 任务 ID
- `task_name`: 任务名称
- `status`: 任务状态，创建时为 `pending`（待启动）
- `total_groups`: 总分组数（系统自动计算）
- `processed_groups`: 已处理分组数（初始为 0）
- `total_questions`: 总题目数（系统自动计算）
- `analysis_type`: 分析类型（full/incremental/custom）
- `estimated_duration`: 预估时长（秒），系统根据题目数量和分组数自动计算
- `config`: 任务配置信息
- `created_at`: 创建时间
- `updated_at`: 更新时间

**注意事项**:

1. 任务创建后状态为 `pending`（待启动），不会立即开始执行
2. 系统会自动计算 `total_groups`（总分组数）和 `total_questions`（总题目数）
3. `estimated_duration` 是根据以下规则估算的：
   - 基础开销：30 秒
   - 每个题目处理时间：0.1 秒
   - 每个分组额外开销：5 秒
   - 公式：`30 + (total_questions * 0.1) + (total_groups * 5)`
4. 前端需要将返回的数据（特别是 `analysis_type`、`total_questions`、`estimated_duration`）存储到数据库中

---

### 3. 获取任务详情

**请求示例**:

```http
GET /api/dedup/tasks/1
```

**路径参数**:

- `task_id`: 1 (任务 ID)

**响应数据**:

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "id": 1,
    "task_name": "查找重复题目-20240101_120000",
    "status": "running",
    "total_groups": 150,
    "processed_groups": 75,
    "total_questions": 2500,
    "exact_duplicate_groups": 2,
    "exact_duplicate_pairs": 5,
    "similar_duplicate_pairs": 3,
    "progress_percentage": 50.0,
    "analysis_type": "full",
    "estimated_duration": 550,
    "started_at": "2024-01-01T12:00:00",
    "completed_at": null,
    "error_message": null,
    "config": {
      "similarity_threshold": 0.8
    },
    "created_at": "2024-01-01T12:00:00",
    "updated_at": "2024-01-01T12:15:00"
  }
}
```

---

### 4. 删除任务

**请求示例**:

```http
DELETE /api/dedup/tasks/1
```

**路径参数**:

- `task_id`: 1 (任务 ID)

**响应数据**:

```json
{
  "success": true,
  "message": "任务删除成功"
}
```

---

### 5. 启动任务

**请求示例**:

```http
POST /api/dedup/tasks/1/start
```

**路径参数**:

- `task_id`: 1 (任务 ID)

**响应数据**:

```json
{
  "success": true,
  "message": "任务已启动",
  "data": {
    "id": 1,
    "status": "running",
    "started_at": "2024-01-01T12:00:00",
    ...
  }
}
```

**错误响应** (任务已在运行中):

```json
{
  "success": false,
  "message": "任务已在运行中",
  "error_code": "INVALID_STATUS"
}
```

---

### 6. 取消任务

**请求示例**:

```http
POST /api/dedup/tasks/1/cancel
```

**路径参数**:

- `task_id`: 1 (任务 ID)

**响应数据**:

```json
{
  "success": true,
  "message": "任务已取消",
  "data": {
    "id": 1,
    "status": "cancelled",
    ...
  }
}
```

---

### 7. 获取完全重复组列表

**请求示例**:

```http
GET /api/dedup/tasks/1/exact-groups?page=1&page_size=20&group_type=1&subject_id=1
```

**路径参数**:

- `task_id`: 1 (任务 ID)

**请求参数**:

- `page`: 1 (页码，默认 1)
- `page_size`: 20 (每页数量，默认 20，最大 100)
- `group_type`: "1" (可选，题型筛选：1=单选, 2=多选, 3=判断, 4=填空, 8=计算分析)
- `subject_id`: 1 (可选，科目 ID 筛选)

**响应数据**:

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "list": [
      {
        "id": 1,
        "task_id": 1,
        "content_hash": "abc123def456...",
        "question_count": 3,
        "question_ids": [101, 102, 103],
        "group": {
          "type": "1",
          "type_name": "单选题",
          "subject_id": 1,
          "subject_name": "数学",
          "channel_code": "A001"
        },
        "detected_at": "2024-01-01T12:05:00"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 50,
      "total_pages": 3
    }
  }
}
```

---

### 8. 获取完全重复组详情

**请求示例**:

```http
GET /api/dedup/tasks/1/exact-groups/1
```

**路径参数**:

- `task_id`: 1 (任务 ID)
- `group_id`: 1 (重复组 ID)

**响应数据**:

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "id": 1,
    "task_id": 1,
    "content_hash": "abc123def456...",
    "question_count": 3,
    "question_ids": [101, 102, 103],
    "group": {
      "type": "1",
      "type_name": "单选题",
      "subject_id": 1,
      "subject_name": "数学",
      "channel_code": "A001"
    },
    "detected_at": "2024-01-01T12:05:00",
    "questions": [
      {
        "question_id": 101,
        "type": "1",
        "type_name": "单选题",
        "subject_id": 1,
        "subject_name": "数学",
        "chapter_id": 5,
        "subject_type": "基础",
        "subject_type_name": "基础",
        "content": "题目内容...",
        "content_detail": "题目详细内容",
        "attr": "01",
        "sort": 0,
        "channel_code": "A001",
        "analysis": "解析内容...",
        "cleaned_content": "清洗后的题目内容",
        "options": [
          {
            "label": "A",
            "content": "选项A内容",
            "seq": 1
          },
          {
            "label": "B",
            "content": "选项B内容",
            "seq": 2
          }
        ],
        "correct_answer": "A",
        "create_time": "2024-01-01T10:00:00"
      }
    ]
  }
}
```

---

### 9. 获取相似重复对列表

**请求示例**:

```http
GET /api/dedup/tasks/1/similar-pairs?page=1&page_size=20&min_similarity=0.85&group_type=1
```

**路径参数**:

- `task_id`: 1 (任务 ID)

**请求参数**:

- `page`: 1 (页码，默认 1)
- `page_size`: 20 (每页数量，默认 20，最大 100)
- `min_similarity`: 0.85 (可选，最小相似度，默认 0.8)
- `group_type`: "1" (可选，题型筛选：1=单选, 2=多选, 3=判断, 4=填空, 8=计算分析)

**响应数据**:

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "list": [
      {
        "id": 1,
        "task_id": 1,
        "question_id_1": 201,
        "question_id_2": 202,
        "similarity": 0.92,
        "duplicate_type": "similar",
        "group": {
          "type": "1",
          "type_name": "单选题",
          "subject_id": 1,
          "subject_name": "数学",
          "channel_code": "A001"
        },
        "detected_at": "2024-01-01T12:10:00"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 30,
      "total_pages": 2
    }
  }
}
```

---

### 10. 获取相似重复对详情

**请求示例**:

```http
GET /api/dedup/tasks/1/similar-pairs/1
```

**路径参数**:

- `task_id`: 1 (任务 ID)
- `pair_id`: 1 (重复对 ID)

**响应数据**:

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "id": 1,
    "task_id": 1,
    "question_id_1": 201,
    "question_id_2": 202,
    "similarity": 0.92,
    "duplicate_type": "similar",
    "group": {
      "type": "1",
      "type_name": "单选题",
      "subject_id": 1,
      "subject_name": "数学",
      "channel_code": "A001"
    },
    "detected_at": "2024-01-01T12:10:00",
    "question_1": {
      "question_id": 201,
      "type": "1",
      "type_name": "单选题",
      "subject_id": 1,
      "subject_name": "数学",
      "chapter_id": 5,
      "subject_type": "基础",
      "subject_type_name": "基础",
      "content": "题目内容1...",
      "content_detail": "题目详细内容1",
      "attr": "01",
      "sort": 0,
      "channel_code": "A001",
      "analysis": "解析内容1...",
      "cleaned_content": "清洗后的题目内容1",
      "options": [
        {
          "label": "A",
          "content": "选项A内容",
          "seq": 1
        }
      ],
      "correct_answer": "A",
      "create_time": "2024-01-01T10:00:00"
    },
    "question_2": {
      "question_id": 202,
      "type": "1",
      "type_name": "单选题",
      "subject_id": 1,
      "subject_name": "数学",
      "chapter_id": 5,
      "subject_type": "基础",
      "subject_type_name": "基础",
      "content": "题目内容2...",
      "content_detail": "题目详细内容2",
      "attr": "01",
      "sort": 0,
      "channel_code": "A001",
      "analysis": "解析内容2...",
      "cleaned_content": "清洗后的题目内容2",
      "options": [
        {
          "label": "A",
          "content": "选项A内容",
          "seq": 1
        }
      ],
      "correct_answer": "A",
      "create_time": "2024-01-01T10:05:00"
    }
  }
}
```

---

### 11. 获取任务统计信息

**请求示例**:

```http
GET /api/dedup/tasks/1/statistics
```

**路径参数**:

- `task_id`: 1 (任务 ID)

**响应数据**:

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "task": {
      "id": 1,
      "task_name": "查找重复题目-20240101_120000",
      "status": "completed",
      "total_groups": 150,
      "processed_groups": 150,
      "total_questions": 2500,
      "exact_duplicate_groups": 2,
      "exact_duplicate_pairs": 5,
      "similar_duplicate_pairs": 3,
      "progress_percentage": 100.0,
      "started_at": "2024-01-01T12:00:00",
      "completed_at": "2024-01-01T13:30:00",
      "error_message": null,
      "config": {
        "similarity_threshold": 0.8
      },
      "created_at": "2024-01-01T12:00:00",
      "updated_at": "2024-01-01T13:30:00"
    },
    "summary": {
      "total_duplicates": 5,
      "exact_duplicate_groups": 2,
      "exact_duplicate_pairs": 5,
      "similar_duplicate_pairs": 3,
      "unique_question_count": 2492
    },
    "by_type": [
      {
        "type": "1",
        "type_name": "单选题",
        "exact_groups": 1,
        "similar_pairs": 2
      },
      {
        "type": "2",
        "type_name": "多选题",
        "exact_groups": 1,
        "similar_pairs": 1
      }
    ],
    "by_subject": [
      {
        "subject_id": 1,
        "subject_name": "数学",
        "exact_groups": 2,
        "similar_pairs": 3
      },
      {
        "subject_id": 2,
        "subject_name": "语文",
        "exact_groups": 0,
        "similar_pairs": 0
      }
    ]
  }
}
```

---

## 错误响应格式

所有接口在发生错误时，都会返回统一的错误响应格式：

```json
{
  "success": false,
  "message": "错误描述信息",
  "error_code": "ERROR_CODE"
}
```

常见错误码：

- `NOT_FOUND`: 资源不存在（404）
- `INVALID_STATUS`: 状态无效（400）
- `INTERNAL_ERROR`: 服务器内部错误（500）

---

## 注意事项

1. **时间格式**: 所有时间字段使用 ISO 8601 格式（如 `2024-01-01T12:00:00`）
2. **分页参数**: `page` 从 1 开始，`page_size` 最大值为 100
3. **题型代码**: 1=单选, 2=多选, 3=判断, 4=填空, 8=计算分析
4. **任务状态**: pending（待处理）、running（运行中）、completed（已完成）、error（错误）、cancelled（已取消）
5. **相似度范围**: 相似度值在 0-1 之间，1 表示完全相同
6. **题目详情**: 获取题目详情时，会根据题型返回对应的选项和答案结构
