# ä»»åŠ¡æš‚åœå’Œç»§ç»­æ¥å£æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å»é‡ä»»åŠ¡çš„æš‚åœå’Œç»§ç»­åŠŸèƒ½æ¥å£ï¼Œå…è®¸ç”¨æˆ·åœ¨ä»»åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­æš‚åœä»»åŠ¡ï¼Œå¹¶åœ¨éœ€è¦æ—¶æ¢å¤è¿è¡Œã€‚

---

## ğŸ”Œ API æ¥å£

### 1. æš‚åœä»»åŠ¡

**æ¥å£åœ°å€**: `POST /api/dedup/tasks/<task_id>/pause`

**è¯·æ±‚æ–¹å¼**: `POST`

**è¯·æ±‚å¤´**: 
```
Content-Type: application/json
Authorization: Bearer <access_token>  # å¦‚æœéœ€è¦è®¤è¯
```

**è·¯å¾„å‚æ•°**:
- `task_id` (integer, å¿…å¡«): ä»»åŠ¡ID

**è¯·æ±‚ä½“**: æ— 

**æˆåŠŸå“åº”** (HTTP 200):
```json
{
  "success": true,
  "message": "ä»»åŠ¡å·²æš‚åœ",
  "data": {
    "id": 1,
    "task_name": "æŸ¥æ‰¾é‡å¤é¢˜ç›®-20240101_120000",
    "status": "paused",
    "total_groups": 150,
    "processed_groups": 75,
    "total_questions": 2500,
    "exact_duplicate_groups": 2,
    "exact_duplicate_pairs": 5,
    "similar_duplicate_pairs": 3,
    "progress_percentage": 50.0,
    "analysis_type": "full",
    "estimated_duration": 550,
    "started_at": "2024-01-01T12:00:00",
    "completed_at": null,
    "created_at": "2024-01-01T12:00:00",
    "updated_at": "2024-01-01T12:15:00"
  }
}
```

**é”™è¯¯å“åº”**:

- ä»»åŠ¡ä¸å­˜åœ¨ (404):
```json
{
  "success": false,
  "message": "ä»»åŠ¡ä¸å­˜åœ¨",
  "error_code": "NOT_FOUND"
}
```

- ä»»åŠ¡çŠ¶æ€ä¸æ­£ç¡® (400):
```json
{
  "success": false,
  "message": "åªèƒ½æš‚åœè¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œå½“å‰çŠ¶æ€ä¸º: pending",
  "error_code": "INVALID_STATUS"
}
```

**å“åº”å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `success` | boolean | æ˜¯å¦æˆåŠŸ |
| `message` | string | å“åº”æ¶ˆæ¯ |
| `data` | object | ä»»åŠ¡æ•°æ® |
| `data.id` | integer | ä»»åŠ¡ID |
| `data.status` | string | ä»»åŠ¡çŠ¶æ€ï¼Œæš‚åœåä¸º `"paused"` |
| `data.progress_percentage` | float | è¿›åº¦ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰ |

---

### 2. ç»§ç»­ä»»åŠ¡

**æ¥å£åœ°å€**: `POST /api/dedup/tasks/<task_id>/resume`

**è¯·æ±‚æ–¹å¼**: `POST`

**è¯·æ±‚å¤´**: 
```
Content-Type: application/json
Authorization: Bearer <access_token>  # å¦‚æœéœ€è¦è®¤è¯
```

**è·¯å¾„å‚æ•°**:
- `task_id` (integer, å¿…å¡«): ä»»åŠ¡ID

**è¯·æ±‚ä½“**: æ— 

**æˆåŠŸå“åº”** (HTTP 200):
```json
{
  "success": true,
  "message": "ä»»åŠ¡å·²æ¢å¤è¿è¡Œ",
  "data": {
    "id": 1,
    "task_name": "æŸ¥æ‰¾é‡å¤é¢˜ç›®-20240101_120000",
    "status": "running",
    "total_groups": 150,
    "processed_groups": 75,
    "total_questions": 2500,
    "exact_duplicate_groups": 2,
    "exact_duplicate_pairs": 5,
    "similar_duplicate_pairs": 3,
    "progress_percentage": 50.0,
    "analysis_type": "full",
    "estimated_duration": 550,
    "started_at": "2024-01-01T12:00:00",
    "completed_at": null,
    "created_at": "2024-01-01T12:00:00",
    "updated_at": "2024-01-01T12:20:00"
  }
}
```

**é”™è¯¯å“åº”**:

- ä»»åŠ¡ä¸å­˜åœ¨ (404):
```json
{
  "success": false,
  "message": "ä»»åŠ¡ä¸å­˜åœ¨",
  "error_code": "NOT_FOUND"
}
```

- ä»»åŠ¡çŠ¶æ€ä¸æ­£ç¡® (400):
```json
{
  "success": false,
  "message": "åªèƒ½ç»§ç»­å·²æš‚åœçš„ä»»åŠ¡ï¼Œå½“å‰çŠ¶æ€ä¸º: running",
  "error_code": "INVALID_STATUS"
}
```

**å“åº”å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `success` | boolean | æ˜¯å¦æˆåŠŸ |
| `message` | string | å“åº”æ¶ˆæ¯ |
| `data` | object | ä»»åŠ¡æ•°æ® |
| `data.id` | integer | ä»»åŠ¡ID |
| `data.status` | string | ä»»åŠ¡çŠ¶æ€ï¼Œæ¢å¤åä¸º `"running"` |
| `data.progress_percentage` | float | è¿›åº¦ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰ |

---

## ğŸ“Š ä»»åŠ¡çŠ¶æ€è¯´æ˜

ä»»åŠ¡çŠ¶æ€æµè½¬å›¾ï¼š

```
pending â†’ running â†’ paused â†’ running â†’ completed
   â†“         â†“         â†“
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         error/cancelled
```

**çŠ¶æ€è¯´æ˜**:

| çŠ¶æ€ | è¯´æ˜ | å¯æ‰§è¡Œæ“ä½œ |
|------|------|-----------|
| `pending` | å¾…å¯åŠ¨ | å¯åŠ¨ä»»åŠ¡ |
| `running` | è¿è¡Œä¸­ | æš‚åœä»»åŠ¡ã€å–æ¶ˆä»»åŠ¡ |
| `paused` | å·²æš‚åœ | ç»§ç»­ä»»åŠ¡ã€å–æ¶ˆä»»åŠ¡ |
| `completed` | å·²å®Œæˆ | æŸ¥çœ‹ç»“æœã€åˆ é™¤ä»»åŠ¡ |
| `error` | æ‰§è¡Œé”™è¯¯ | æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ã€åˆ é™¤ä»»åŠ¡ |
| `cancelled` | å·²å–æ¶ˆ | åˆ é™¤ä»»åŠ¡ |

---

## ğŸ”” WebSocket å®æ—¶é€šçŸ¥

æš‚åœå’Œç»§ç»­æ“ä½œä¼šé€šè¿‡ WebSocket å®æ—¶æ¨é€çŠ¶æ€æ›´æ–°ã€‚

### æš‚åœé€šçŸ¥

å½“ä»»åŠ¡è¢«æš‚åœæ—¶ï¼Œä¼šå‘é€ä»¥ä¸‹ WebSocket äº‹ä»¶ï¼š

**äº‹ä»¶å**: `task_progress`

**æ•°æ®æ ¼å¼**:
```json
{
  "task_id": 1,
  "status": "paused",
  "processed_groups": 75,
  "total_groups": 150,
  "progress_percentage": 50.0,
  "message": "ä»»åŠ¡å·²æš‚åœ"
}
```

### æ¢å¤é€šçŸ¥

å½“ä»»åŠ¡æ¢å¤è¿è¡Œæ—¶ï¼Œä¼šå‘é€ä»¥ä¸‹ WebSocket äº‹ä»¶ï¼š

**äº‹ä»¶å**: `task_progress`

**æ•°æ®æ ¼å¼**:
```json
{
  "task_id": 1,
  "status": "running",
  "processed_groups": 75,
  "total_groups": 150,
  "progress_percentage": 50.0,
  "message": "ä»»åŠ¡å·²æ¢å¤è¿è¡Œ"
}
```

---

## ğŸ’» å‰ç«¯å¯¹æ¥ç¤ºä¾‹

### TypeScript/JavaScript ç¤ºä¾‹

```typescript
// API æœåŠ¡ç±»
class DedupTaskService {
  private baseURL = '/api/dedup/tasks';
  
  /**
   * æš‚åœä»»åŠ¡
   */
  async pauseTask(taskId: number): Promise<TaskResponse> {
    const response = await fetch(`${this.baseURL}/${taskId}/pause`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        // 'Authorization': `Bearer ${token}` // å¦‚æœéœ€è¦è®¤è¯
      }
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'æš‚åœä»»åŠ¡å¤±è´¥');
    }
    
    return await response.json();
  }
  
  /**
   * ç»§ç»­ä»»åŠ¡
   */
  async resumeTask(taskId: number): Promise<TaskResponse> {
    const response = await fetch(`${this.baseURL}/${taskId}/resume`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        // 'Authorization': `Bearer ${token}` // å¦‚æœéœ€è¦è®¤è¯
      }
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'æ¢å¤ä»»åŠ¡å¤±è´¥');
    }
    
    return await response.json();
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const taskService = new DedupTaskService();

// æš‚åœä»»åŠ¡
try {
  const result = await taskService.pauseTask(1);
  console.log('ä»»åŠ¡å·²æš‚åœ:', result.data);
  // æ›´æ–°UIçŠ¶æ€
  updateTaskStatus(result.data);
} catch (error) {
  console.error('æš‚åœä»»åŠ¡å¤±è´¥:', error);
  showErrorMessage(error.message);
}

// ç»§ç»­ä»»åŠ¡
try {
  const result = await taskService.resumeTask(1);
  console.log('ä»»åŠ¡å·²æ¢å¤:', result.data);
  // æ›´æ–°UIçŠ¶æ€
  updateTaskStatus(result.data);
} catch (error) {
  console.error('æ¢å¤ä»»åŠ¡å¤±è´¥:', error);
  showErrorMessage(error.message);
}
```

### Vue 3 ç¤ºä¾‹

```vue
<template>
  <div class="task-controls">
    <el-button 
      v-if="task.status === 'running'"
      type="warning"
      @click="handlePause"
      :loading="pausing"
    >
      æš‚åœä»»åŠ¡
    </el-button>
    
    <el-button 
      v-if="task.status === 'paused'"
      type="success"
      @click="handleResume"
      :loading="resuming"
    >
      ç»§ç»­ä»»åŠ¡
    </el-button>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { ElMessage } from 'element-plus';

interface Task {
  id: number;
  status: string;
  // ... å…¶ä»–å­—æ®µ
}

const props = defineProps<{
  task: Task;
}>();

const emit = defineEmits<{
  (e: 'update', task: Task): void;
}>();

const pausing = ref(false);
const resuming = ref(false);

// æš‚åœä»»åŠ¡
const handlePause = async () => {
  pausing.value = true;
  try {
    const response = await fetch(`/api/dedup/tasks/${props.task.id}/pause`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      ElMessage.success('ä»»åŠ¡å·²æš‚åœ');
      emit('update', result.data);
    } else {
      ElMessage.error(result.message || 'æš‚åœä»»åŠ¡å¤±è´¥');
    }
  } catch (error) {
    ElMessage.error('æš‚åœä»»åŠ¡å¤±è´¥');
    console.error(error);
  } finally {
    pausing.value = false;
  }
};

// ç»§ç»­ä»»åŠ¡
const handleResume = async () => {
  resuming.value = true;
  try {
    const response = await fetch(`/api/dedup/tasks/${props.task.id}/resume`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      ElMessage.success('ä»»åŠ¡å·²æ¢å¤è¿è¡Œ');
      emit('update', result.data);
    } else {
      ElMessage.error(result.message || 'æ¢å¤ä»»åŠ¡å¤±è´¥');
    }
  } catch (error) {
    ElMessage.error('æ¢å¤ä»»åŠ¡å¤±è´¥');
    console.error(error);
  } finally {
    resuming.value = false;
  }
};
</script>
```

### React Hooks ç¤ºä¾‹

```typescript
import { useState } from 'react';
import { message } from 'antd';

interface Task {
  id: number;
  status: string;
  // ... å…¶ä»–å­—æ®µ
}

interface UseTaskControlProps {
  task: Task;
  onUpdate?: (task: Task) => void;
}

export const useTaskControl = ({ task, onUpdate }: UseTaskControlProps) => {
  const [pausing, setPausing] = useState(false);
  const [resuming, setResuming] = useState(false);
  
  // æš‚åœä»»åŠ¡
  const pauseTask = async () => {
    setPausing(true);
    try {
      const response = await fetch(`/api/dedup/tasks/${task.id}/pause`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        message.success('ä»»åŠ¡å·²æš‚åœ');
        onUpdate?.(result.data);
      } else {
        message.error(result.message || 'æš‚åœä»»åŠ¡å¤±è´¥');
      }
    } catch (error) {
      message.error('æš‚åœä»»åŠ¡å¤±è´¥');
      console.error(error);
    } finally {
      setPausing(false);
    }
  };
  
  // ç»§ç»­ä»»åŠ¡
  const resumeTask = async () => {
    setResuming(true);
    try {
      const response = await fetch(`/api/dedup/tasks/${task.id}/resume`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        message.success('ä»»åŠ¡å·²æ¢å¤è¿è¡Œ');
        onUpdate?.(result.data);
      } else {
        message.error(result.message || 'æ¢å¤ä»»åŠ¡å¤±è´¥');
      }
    } catch (error) {
      message.error('æ¢å¤ä»»åŠ¡å¤±è´¥');
      console.error(error);
    } finally {
      setResuming(false);
    }
  };
  
  return {
    pauseTask,
    resumeTask,
    pausing,
    resuming,
    canPause: task.status === 'running',
    canResume: task.status === 'paused',
  };
};

// ä½¿ç”¨ç¤ºä¾‹
const TaskControl: React.FC<{ task: Task }> = ({ task }) => {
  const { pauseTask, resumeTask, pausing, resuming, canPause, canResume } = 
    useTaskControl({ 
      task,
      onUpdate: (updatedTask) => {
        // æ›´æ–°ä»»åŠ¡çŠ¶æ€
        console.log('ä»»åŠ¡å·²æ›´æ–°:', updatedTask);
      }
    });
  
  return (
    <div>
      {canPause && (
        <Button 
          type="warning" 
          onClick={pauseTask} 
          loading={pausing}
        >
          æš‚åœä»»åŠ¡
        </Button>
      )}
      
      {canResume && (
        <Button 
          type="primary" 
          onClick={resumeTask} 
          loading={resuming}
        >
          ç»§ç»­ä»»åŠ¡
        </Button>
      )}
    </div>
  );
};
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. çŠ¶æ€é™åˆ¶

- **æš‚åœä»»åŠ¡**: åªèƒ½æš‚åœçŠ¶æ€ä¸º `running` çš„ä»»åŠ¡
- **ç»§ç»­ä»»åŠ¡**: åªèƒ½ç»§ç»­çŠ¶æ€ä¸º `paused` çš„ä»»åŠ¡
- å…¶ä»–çŠ¶æ€çš„ä»»åŠ¡è°ƒç”¨è¿™äº›æ¥å£ä¼šè¿”å› `INVALID_STATUS` é”™è¯¯

### 2. æš‚åœæ—¶æœº

- ä»»åŠ¡ä¼šåœ¨**å®Œæˆå½“å‰åˆ†ç»„çš„å¤„ç†**åæš‚åœ
- ä¸ä¼šç«‹å³ä¸­æ–­æ­£åœ¨å¤„ç†çš„åˆ†ç»„
- æš‚åœåï¼Œä»»åŠ¡ä¼šä¿æŒå½“å‰è¿›åº¦ï¼Œä¸ä¼šä¸¢å¤±å·²å¤„ç†çš„æ•°æ®

### 3. WebSocket é€šçŸ¥

- æš‚åœå’Œæ¢å¤æ“ä½œä¼šé€šè¿‡ WebSocket å®æ—¶æ¨é€çŠ¶æ€æ›´æ–°
- å‰ç«¯åº”è¯¥ç›‘å¬ `task_progress` äº‹ä»¶æ¥æ›´æ–°UIçŠ¶æ€
- å»ºè®®åŒæ—¶ä½¿ç”¨ HTTP æ¥å£å’Œ WebSocket é€šçŸ¥ï¼Œç¡®ä¿çŠ¶æ€åŒæ­¥

### 4. é”™è¯¯å¤„ç†

- æ‰€æœ‰æ¥å£éƒ½è¿”å›ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼
- å‰ç«¯åº”è¯¥æ ¹æ® `error_code` è¿›è¡Œç›¸åº”çš„é”™è¯¯å¤„ç†
- å¸¸è§é”™è¯¯ç ï¼š
  - `NOT_FOUND`: ä»»åŠ¡ä¸å­˜åœ¨
  - `INVALID_STATUS`: ä»»åŠ¡çŠ¶æ€ä¸æ­£ç¡®
  - `INTERNAL_ERROR`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

### 5. å¹¶å‘æ§åˆ¶

- åŒä¸€ä»»åŠ¡ä¸åº”è¯¥åŒæ—¶è°ƒç”¨å¤šä¸ªæš‚åœ/ç»§ç»­æ¥å£
- å»ºè®®åœ¨å‰ç«¯æ·»åŠ é˜²æŠ–æˆ–èŠ‚æµæœºåˆ¶
- å¯ä»¥é€šè¿‡æŒ‰é’®çš„ `loading` çŠ¶æ€é˜²æ­¢é‡å¤ç‚¹å‡»

---

## ğŸ”— ç›¸å…³æ¥å£

- [åˆ›å»ºä»»åŠ¡æ¥å£](./åˆ›å»ºä»»åŠ¡æ¥å£å®Œæˆè¯´æ˜.md)
- [å¯åŠ¨ä»»åŠ¡æ¥å£](./é¢˜ç›®å»é‡æ¥å£å‰ç«¯å¯¹æ¥.md)
- [å–æ¶ˆä»»åŠ¡æ¥å£](./é¢˜ç›®å»é‡æ¥å£å‰ç«¯å¯¹æ¥.md)
- [WebSocket å®æ—¶è¿›åº¦æ¨é€æ¥å£](./WebSocketå®æ—¶è¿›åº¦æ¨é€æ¥å£æ–‡æ¡£.md)

---

## ğŸ“‹ æµ‹è¯•ç¤ºä¾‹

### ä½¿ç”¨ curl æµ‹è¯•

```bash
# æš‚åœä»»åŠ¡
curl -X POST http://localhost:5000/api/dedup/tasks/1/pause \
  -H "Content-Type: application/json"

# ç»§ç»­ä»»åŠ¡
curl -X POST http://localhost:5000/api/dedup/tasks/1/resume \
  -H "Content-Type: application/json"
```

### ä½¿ç”¨ Postman æµ‹è¯•

1. **æš‚åœä»»åŠ¡**:
   - Method: `POST`
   - URL: `http://localhost:5000/api/dedup/tasks/1/pause`
   - Headers: `Content-Type: application/json`

2. **ç»§ç»­ä»»åŠ¡**:
   - Method: `POST`
   - URL: `http://localhost:5000/api/dedup/tasks/1/resume`
   - Headers: `Content-Type: application/json`

---

## âœ… åŠŸèƒ½ç‰¹æ€§

- âœ… æ”¯æŒæš‚åœè¿è¡Œä¸­çš„ä»»åŠ¡
- âœ… æ”¯æŒç»§ç»­å·²æš‚åœçš„ä»»åŠ¡
- âœ… å®æ—¶ WebSocket çŠ¶æ€é€šçŸ¥
- âœ… å®Œå–„çš„çŠ¶æ€éªŒè¯å’Œé”™è¯¯å¤„ç†
- âœ… ä¿æŒä»»åŠ¡è¿›åº¦ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ 
- âœ… ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å’Œæµè½¬

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024-01-05  
**ç»´æŠ¤äººå‘˜**: å¼€å‘å›¢é˜Ÿ

