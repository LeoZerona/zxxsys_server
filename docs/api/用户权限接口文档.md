# 用户权限接口文档

## 📋 概述

用户登录成功后，系统会根据用户角色返回对应的权限信息，包括：
- **操作权限列表**：用户可以在系统中执行的操作
- **菜单列表**：用户可访问的前端菜单和路由配置

---

## 🔌 API 接口

### 登录接口（返回权限信息）

**接口地址**: `POST /api/login`

**请求方式**: `POST`

**请求参数**:
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**成功响应** (HTTP 200):
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "role": "user",
      "created_at": "2024-01-01T00:00:00",
      "is_active": true
    },
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "Bearer",
    "expires_in": 1800,
    "permissions": [
      "test:view",
      "questionBank:view",
      "questionBank:detail",
      "questionBank:type",
      "cleaningWarehouse:view",
      "examinationPaper:view"
    ],
    "menus": [
      {
        "path": "/",
        "alias": ["/login"],
        "name": "login",
        "component": "@/pages/login/index.vue",
        "meta": {
          "requiresAuth": false,
          "title": "登录",
          "icon": null,
          "hidden": false
        },
        "children": []
      },
      {
        "path": "/second",
        "name": "second",
        "component": "@/pages/second/index.vue",
        "meta": {
          "requiresAuth": true,
          "title": "主页面",
          "icon": "home",
          "hidden": false
        },
        "children": [
          {
            "path": "test",
            "name": "test",
            "component": "@/pages/test/index.vue",
            "meta": {
              "requiresAuth": true,
              "title": "测试页",
              "icon": "test",
              "hidden": false
            },
            "permissions": ["test:view"]
          },
          {
            "path": "originalQuestionBank",
            "name": "originalQuestionBank",
            "component": "@/pages/originalQuestionBank/index.vue",
            "meta": {
              "requiresAuth": true,
              "title": "原题库",
              "icon": "book",
              "hidden": false
            },
            "permissions": ["questionBank:view"]
          }
        ]
      }
    ]
  }
}
```

---

## 📊 数据字段说明

### 1. permissions（操作权限列表）

类型：`string[]`

用户拥有的所有操作权限标识列表。

**权限命名规则**：
- 格式：`资源:操作`
- 例如：`questionBank:view`、`questionBank:create`、`questionBank:delete`

**常用权限说明**：

| 权限标识 | 说明 |
|---------|------|
| `test:view` | 查看测试页 |
| `test:create` | 创建测试内容 |
| `test:edit` | 编辑测试内容 |
| `test:delete` | 删除测试内容 |
| `questionBank:view` | 查看题库 |
| `questionBank:create` | 创建题库 |
| `questionBank:edit` | 编辑题库 |
| `questionBank:delete` | 删除题库 |
| `questionBank:detail` | 查看题库详情 |
| `questionBank:type` | 查看题目类型 |
| `questionBank:import` | 导入题库 |
| `questionBank:export` | 导出题库 |
| `cleaningWarehouse:view` | 查看清洗库 |
| `cleaningWarehouse:create` | 创建清洗库内容 |
| `cleaningWarehouse:edit` | 编辑清洗库内容 |
| `cleaningWarehouse:delete` | 删除清洗库内容 |
| `cleaningWarehouse:process` | 处理清洗库 |
| `cleaningWarehouse:export` | 导出清洗库 |
| `examinationPaper:view` | 查看试卷 |
| `examinationPaper:create` | 创建试卷 |
| `examinationPaper:edit` | 编辑试卷 |
| `examinationPaper:delete` | 删除试卷 |
| `examinationPaper:export` | 导出试卷 |
| `examinationPaper:publish` | 发布试卷 |

---

### 2. menus（菜单列表）

类型：`Menu[]`

用户可访问的前端路由/菜单配置列表。

#### Menu 对象结构

```typescript
interface Menu {
  path: string;              // 路由路径
  alias?: string[];          // 路由别名（可选）
  name: string;              // 路由名称
  component: string;         // 组件路径
  props?: boolean;           // 是否传递路由参数（可选）
  meta: {
    requiresAuth: boolean;   // 是否需要认证
    title: string;           // 菜单标题
    icon: string | null;     // 图标（可选）
    hidden: boolean;         // 是否在菜单中隐藏
  };
  children?: Menu[];         // 子菜单（可选）
  permissions?: string[];    // 菜单所需的权限（可选）
}
```

#### Meta 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| requiresAuth | boolean | 是否需要登录认证才能访问 |
| title | string | 菜单显示标题 |
| icon | string \| null | 菜单图标标识（可选） |
| hidden | boolean | 是否在菜单中隐藏（true=隐藏，false=显示） |

#### Children 子菜单说明

子菜单结构与父菜单相同，递归定义。

**注意事项**：
- 如果子菜单有 `permissions` 字段，只有用户拥有其中任一权限才能看到该菜单项
- 如果子菜单设置了 `hidden: true`，则不会在菜单中显示（但可以访问）
- 详情页、动态路由等通常设置为 `hidden: true`

---

## 👥 角色权限说明

### 超级管理员 (super_admin)

- **权限**：所有权限（`*` 通配符）
- **菜单**：所有菜单
- **说明**：拥有系统的完全访问权限

### 管理员 (admin)

- **权限**：除系统管理外的所有操作权限
- **菜单**：所有菜单
- **说明**：可以管理内容，但无法管理系统配置

### 普通用户 (user)

- **权限**：只读权限
  - `test:view`
  - `questionBank:view`
  - `questionBank:detail`
  - `questionBank:type`
  - `cleaningWarehouse:view`
  - `examinationPaper:view`
- **菜单**：所有菜单（但操作受限）
- **说明**：只能查看内容，无法创建、编辑或删除

---

## 💻 前端使用建议

### 1. 存储权限信息

登录成功后，建议将权限信息存储到前端：

```typescript
// 存储权限和菜单
localStorage.setItem('permissions', JSON.stringify(response.data.permissions));
localStorage.setItem('menus', JSON.stringify(response.data.menus));
```

### 2. 菜单渲染

使用返回的 `menus` 列表动态生成菜单：

```typescript
// 过滤菜单（排除 hidden: true 的菜单）
const visibleMenus = menus.filter(menu => !menu.meta.hidden);

// 递归渲染菜单
function renderMenu(menu: Menu) {
  if (menu.meta.hidden) return null;
  
  // 检查权限
  if (menu.permissions) {
    const hasPermission = menu.permissions.some(perm => 
      userPermissions.includes(perm)
    );
    if (!hasPermission) return null;
  }
  
  return (
    <MenuItem>
      {menu.meta.title}
      {menu.children?.map(child => renderMenu(child))}
    </MenuItem>
  );
}
```

### 3. 权限控制

在页面或组件中检查权限：

```typescript
// 检查是否有指定权限
function hasPermission(permission: string): boolean {
  const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
  return permissions.includes(permission);
}

// 使用示例
if (hasPermission('questionBank:create')) {
  // 显示创建按钮
}

// 在 Vue Router 中使用
router.beforeEach((to, from, next) => {
  const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
  const requiredPerms = to.meta.permissions || [];
  
  if (requiredPerms.length > 0) {
    const hasAccess = requiredPerms.some(perm => permissions.includes(perm));
    if (!hasAccess) {
      next('/unauthorized');
      return;
    }
  }
  
  next();
});
```

### 4. 按钮权限控制

根据权限显示/隐藏操作按钮：

```vue
<template>
  <div>
    <el-button 
      v-if="hasPermission('questionBank:create')"
      @click="handleCreate"
    >
      创建题库
    </el-button>
    
    <el-button 
      v-if="hasPermission('questionBank:edit')"
      @click="handleEdit"
    >
      编辑
    </el-button>
    
    <el-button 
      v-if="hasPermission('questionBank:delete')"
      type="danger"
      @click="handleDelete"
    >
      删除
    </el-button>
  </div>
</template>

<script setup>
import { computed } from 'vue';

const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');

const hasPermission = (permission) => {
  return permissions.includes(permission);
};
</script>
```

---

## 🔄 权限更新

权限信息在以下情况会更新：
1. **用户登录时**：每次登录都会返回最新的权限信息
2. **角色变更后**：需要重新登录才能获取新权限
3. **Token 刷新时**：权限信息不会自动更新，需要重新登录

**建议**：
- 权限变更后，提示用户重新登录
- 或在权限变更接口中主动刷新前端权限信息

---

## 📝 注意事项

1. **菜单权限过滤**：后端已根据用户角色过滤菜单，前端可以直接使用
2. **操作权限检查**：前端需要根据 `permissions` 列表控制按钮和操作的显示
3. **权限验证**：前端权限控制只是UI层面的控制，真正的权限验证需要后端接口保证
4. **菜单隐藏**：`hidden: true` 的菜单不会在菜单栏显示，但路由仍然可以访问（需要权限）
5. **动态路由**：带参数的路由（如 `/questionBankDetail/:id`）通常设置为 `hidden: true`

---

## 🔗 相关文档

- [登录接口文档](./API.md)
- [登录验证码接口文档](./登录验证码接口文档.md)

