# 登录验证码接口文档

## 📋 概述

当用户在 **10 分钟内连续登录失败 10 次**后，系统会要求输入验证码才能继续登录。

---

## 🔌 API 接口

### 1. 获取验证码

**接口地址**: `GET /api/captcha`

**请求方式**: `GET`

**请求头**: 
```
无特殊要求
```

**请求参数**: 无

**成功响应** (HTTP 200):
```json
{
  "success": true,
  "message": "验证码生成成功",
  "data": {
    "captcha_code": "1234",
    "session_key": "a1b2c3d4e5f6g7h8",
    "expires_in": 300
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否成功 |
| message | string | 响应消息 |
| data | object | 验证码数据 |
| data.captcha_code | string | 验证码（4位数字），用于前端显示给用户 |
| data.session_key | string | 会话键（16位字符串），用于登录时标识验证码 |
| data.expires_in | integer | 验证码有效期（秒），默认 300 秒（5分钟） |

**错误响应**: 正常情况下不会失败（返回 200）

---

### 2. 用户登录（支持验证码）

**接口地址**: `POST /api/login`

**请求方式**: `POST`

**请求头**: 
```
Content-Type: application/json
```

**请求参数**:

```json
{
  "email": "user@example.com",
  "password": "password123",
  "captcha_session_key": "a1b2c3d4e5f6g7h8",
  "captcha_code": "1234"
}
```

**请求字段说明**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| email | string | 是 | 用户邮箱 |
| password | string | 是 | 用户密码 |
| captcha_session_key | string | 否 | 验证码会话键（从获取验证码接口获取），当需要验证码时必须提供 |
| captcha_code | string | 否 | 用户输入的验证码（4位数字），当需要验证码时必须提供 |

**正常登录成功响应** (HTTP 200):
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "role": "user",
      "created_at": "2024-01-01T00:00:00",
      "is_active": true
    },
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "Bearer",
    "expires_in": 1800
  }
}
```

**需要验证码时的响应** (HTTP 400):
```json
{
  "success": false,
  "message": "登录失败次数过多，请输入验证码",
  "code": "REQUIRES_CAPTCHA",
  "requires_captcha": true,
  "attempt_count": 10
}
```

**验证码错误时的响应** (HTTP 400):
```json
{
  "success": false,
  "message": "验证码错误",
  "code": "INVALID_CAPTCHA",
  "requires_captcha": true
}
```

**验证码过期的响应** (HTTP 400):
```json
{
  "success": false,
  "message": "验证码已过期，请重新获取",
  "code": "INVALID_CAPTCHA"
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否成功 |
| message | string | 响应消息 |
| code | string | 错误代码（失败时返回）<br>- `REQUIRES_CAPTCHA`: 需要验证码<br>- `INVALID_CAPTCHA`: 验证码错误或过期 |
| requires_captcha | boolean | 是否需要验证码 |
| attempt_count | integer | 当前失败次数（仅在需要验证码时返回） |
| data | object | 登录成功时的数据（仅成功时返回） |
| data.user | object | 用户信息 |
| data.access_token | string | 访问令牌 |
| data.refresh_token | string | 刷新令牌 |
| data.token_type | string | Token 类型，固定为 "Bearer" |
| data.expires_in | integer | Token 有效期（秒） |

---

## 📝 错误码说明

| 错误码 | HTTP状态码 | 说明 | 处理建议 |
|--------|-----------|------|---------|
| `REQUIRES_CAPTCHA` | 400 | 登录失败次数过多，需要验证码 | 调用获取验证码接口，显示验证码输入框 |
| `INVALID_CAPTCHA` | 400 | 验证码错误或过期 | 提示用户重新输入验证码或重新获取 |
| `USER_BANNED` | 403 | 账户已被禁用 | 提示用户联系管理员 |

---

## 🔄 业务流程

### 正常登录流程

```
1. 用户输入邮箱和密码
2. 前端调用 POST /api/login（不携带验证码参数）
3. 如果成功 → 返回 Token 和用户信息
4. 如果失败 → 返回错误信息（如果不是需要验证码的错误）
```

### 需要验证码的登录流程

```
1. 用户输入邮箱和密码（前 10 次失败）
2. 第 11 次失败时，后端返回：
   {
     "code": "REQUIRES_CAPTCHA",
     "requires_captcha": true,
     "attempt_count": 10
   }
3. 前端检测到 requires_captcha = true：
   - 调用 GET /api/captcha 获取验证码
   - 显示验证码给用户（使用 data.captcha_code）
   - 显示验证码输入框
4. 用户输入验证码后，前端再次调用 POST /api/login：
   {
     "email": "user@example.com",
     "password": "password123",
     "captcha_session_key": "a1b2c3d4e5f6g7h8",  // 从获取验证码接口获取
     "captcha_code": "1234"  // 用户输入的验证码
   }
5. 后端验证验证码和登录信息
   - 全部验证通过 → 返回 Token，登录成功
   - 验证码错误 → 返回 INVALID_CAPTCHA，可重新输入
   - 验证码过期 → 返回错误，需要重新获取验证码
```

---

## 📋 前端对接要点

1. **判断是否需要验证码**
   - 检查登录接口返回的 `code` 字段是否为 `REQUIRES_CAPTCHA`
   - 或检查 `requires_captcha` 字段是否为 `true`

2. **获取验证码**
   - 当检测到需要验证码时，调用 `GET /api/captcha`
   - 保存返回的 `session_key`（用于后续登录）
   - 显示 `captcha_code` 给用户（也可以生成图形验证码）

3. **提交登录**
   - 如果需要验证码，必须在请求中携带 `captcha_session_key` 和 `captcha_code`
   - 验证码不区分大小写（虽然是数字，但建议统一处理）

4. **处理验证码错误**
   - 如果返回 `INVALID_CAPTCHA`，提示用户验证码错误
   - 如果验证码过期，可以提示用户点击刷新获取新验证码

5. **验证码有效期**
   - 验证码有效期为 5 分钟（`expires_in` 字段）
   - 前端可以根据需要实现自动刷新或提示过期

---

## 🔒 安全说明

1. **验证码一次性使用**：每个验证码只能使用一次，验证后会自动清除
2. **验证码有效期**：验证码有效期为 5 分钟，过期后需要重新获取
3. **失败次数限制**：10 分钟内连续失败 10 次后需要验证码
4. **自动重置**：登录成功后，失败记录会自动清除
5. **时间窗口**：超过 10 分钟后，失败次数会自动重置

---

## 🌐 接口地址

**基础URL**: `http://localhost:5000`

**完整接口地址**:
- 获取验证码: `GET http://localhost:5000/api/captcha`
- 用户登录: `POST http://localhost:5000/api/login`

---

## 📌 注意事项

1. **验证码显示方式**：后端返回的是纯文本验证码（4位数字），前端可以：
   - 直接显示文本
   - 使用图形库渲染成图片
   - 使用第三方验证码服务（如 Google reCAPTCHA）

2. **Session 管理**：验证码使用后端 Session 存储，前端需要确保：
   - 同一浏览器会话中获取和验证验证码
   - 跨域请求时配置正确的 CORS 和 Cookie 设置

3. **错误处理**：建议前端实现：
   - 验证码输入错误时的友好提示
   - 验证码过期的自动刷新机制
   - 登录失败次数接近限制时的提示

---

## 🔗 相关接口

- [登录接口完整文档](./API.md)
- [身份验证中间件说明](../身份验证中间件使用说明.md)

