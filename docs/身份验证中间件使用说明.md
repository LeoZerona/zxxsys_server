# ç»Ÿä¸€èº«ä»½éªŒè¯ä¸­é—´ä»¶ä½¿ç”¨è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†å®Œæ•´çš„èº«ä»½éªŒè¯å’Œæˆæƒç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š

1. **JWT Token è®¤è¯** - ä½¿ç”¨ Access Token å’Œ Refresh Token
2. **ç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶** - è‡ªåŠ¨æ‹¦æˆªè¯·æ±‚å¹¶éªŒè¯ Token
3. **RBAC æƒé™æ§åˆ¶** - åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
4. **CSRF é˜²æŠ¤** - è·¨ç«™è¯·æ±‚ä¼ªé€ é˜²æŠ¤
5. **ç”¨æˆ·çŠ¶æ€æ£€æŸ¥** - è‡ªåŠ¨æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¢«å°ç¦

## ğŸ”„ è®¤è¯æµç¨‹

```
1. æ¥æ”¶è¯·æ±‚
   â†“
2. ä¸­é—´ä»¶æ‹¦æˆªï¼ˆæ£€æŸ¥æ˜¯å¦éœ€è¦è®¤è¯ï¼‰
   â†“
3. æå– Tokenï¼ˆä» Authorization headerï¼‰
   â†“
4. éªŒè¯ç­¾å/æœ‰æ•ˆæœŸ
   â†“
5. æŸ¥è¯¢ç”¨æˆ·çŠ¶æ€ï¼ˆæ˜¯å¦è¢«å°ç¦ï¼‰
   â†“
6. é™„åŠ  user å¯¹è±¡åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆg.current_userï¼‰
   â†“
7. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
   â†“
8. è¿”å›æ•°æ®
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install PyJWT==2.8.0
```

### 2. é…ç½® JWT å¯†é’¥

åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½®ï¼š

```env
# JWT å¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼‰
SECRET_KEY=your-secret-key-here

# Token è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼Œé»˜è®¤å€¼ï¼‰
ACCESS_TOKEN_EXPIRE=3600  # Access Token è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤1å°æ—¶ï¼‰
REFRESH_TOKEN_EXPIRE=604800  # Refresh Token è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤7å¤©ï¼‰
```

## ğŸ“¡ API æ¥å£

### 1. ç™»å½•æ¥å£

**POST** `/api/login`

**è¯·æ±‚ä½“ï¼š**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**å“åº”ï¼š**
```json
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "role": "user",
      "is_active": true
    },
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "Bearer",
    "expires_in": 3600
  }
}
```

### 2. åˆ·æ–° Token æ¥å£

**POST** `/api/refresh-token`

**è¯·æ±‚ä½“ï¼š**
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**å“åº”ï¼š**
```json
{
  "success": true,
  "message": "Token åˆ·æ–°æˆåŠŸ",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "Bearer",
    "expires_in": 3600
  }
}
```

### 3. ç™»å‡ºæ¥å£

**POST** `/api/logout`

**è¯·æ±‚å¤´ï¼š**
```
Authorization: Bearer <access_token>
X-CSRF-Token: <csrf_token>  # å¯é€‰
```

**è¯·æ±‚ä½“ï¼ˆå¯é€‰ï¼‰ï¼š**
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### 4. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

**GET** `/api/users/me`

**è¯·æ±‚å¤´ï¼š**
```
Authorization: Bearer <access_token>
```

## ğŸ”’ ä½¿ç”¨è®¤è¯è£…é¥°å™¨

### 1. ç™»å½•éªŒè¯è£…é¥°å™¨

```python
from src.utils.jwt_utils import login_required
from flask import jsonify, g

@app.route('/api/protected')
@login_required
def protected_route():
    # å½“å‰ç™»å½•ç”¨æˆ·
    user = g.current_user
    
    return jsonify({
        'success': True,
        'message': f'Hello {user.email}'
    })
```

### 2. è§’è‰²æƒé™è£…é¥°å™¨

```python
from src.utils.jwt_utils import role_required

@app.route('/api/admin')
@login_required
@role_required('admin', 'super_admin')
def admin_route():
    # åªæœ‰ç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®
    return jsonify({'message': 'Admin access granted'})
```

### 3. æƒé™ç‚¹è£…é¥°å™¨

```python
from src.utils.jwt_utils import permission_required

@app.route('/api/articles')
@login_required
@permission_required('article:read')
def get_articles():
    # éœ€è¦ article:read æƒé™
    return jsonify({'articles': []})
```

## ğŸ›¡ï¸ CSRF é˜²æŠ¤

### å‰ç«¯ä½¿ç”¨

1. **è·å– CSRF Token**ï¼ˆåœ¨ç™»å½•æˆ–é¦–æ¬¡è®¿é—®æ—¶ï¼‰

```typescript
// ä»ç™»å½•å“åº”ä¸­è·å–ï¼Œæˆ–å•ç‹¬è¯·æ±‚è·å–
const csrfToken = response.headers['x-csrf-token'];
```

2. **å‘é€è¯·æ±‚æ—¶æºå¸¦ CSRF Token**

```typescript
fetch('/api/sensitive-endpoint', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${accessToken}`,
    'X-CSRF-Token': csrfToken,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(data)
});
```

### åç«¯ä½¿ç”¨

```python
from src.middleware.auth_middleware import csrf_protect

@app.route('/api/sensitive')
@csrf_protect
@login_required
def sensitive_route():
    return jsonify({'message': 'Protected route'})
```

## ğŸ“ å‰ç«¯é›†æˆç¤ºä¾‹

### Vue 3 + TypeScript

```typescript
// auth.ts
interface LoginResponse {
  success: boolean;
  data: {
    user: User;
    access_token: string;
    refresh_token: string;
    expires_in: number;
  };
}

export async function login(email: string, password: string): Promise<LoginResponse> {
  const response = await fetch('/api/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ email, password }),
  });
  
  const data = await response.json();
  
  if (data.success) {
    // å­˜å‚¨ Token
    localStorage.setItem('access_token', data.data.access_token);
    localStorage.setItem('refresh_token', data.data.refresh_token);
    
    // è®¾ç½® Token è¿‡æœŸæ—¶é—´
    const expiresAt = Date.now() + data.data.expires_in * 1000;
    localStorage.setItem('token_expires_at', expiresAt.toString());
  }
  
  return data;
}

// è‡ªåŠ¨åˆ·æ–° Token
export async function refreshAccessToken(): Promise<string | null> {
  const refreshToken = localStorage.getItem('refresh_token');
  
  if (!refreshToken) {
    return null;
  }
  
  try {
    const response = await fetch('/api/refresh-token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ refresh_token: refreshToken }),
    });
    
    const data = await response.json();
    
    if (data.success) {
      localStorage.setItem('access_token', data.data.access_token);
      const expiresAt = Date.now() + data.data.expires_in * 1000;
      localStorage.setItem('token_expires_at', expiresAt.toString());
      return data.data.access_token;
    }
  } catch (error) {
    console.error('Token åˆ·æ–°å¤±è´¥:', error);
  }
  
  return null;
}

// å¸¦è®¤è¯çš„è¯·æ±‚
export async function authenticatedFetch(
  url: string,
  options: RequestInit = {}
): Promise<Response> {
  let accessToken = localStorage.getItem('access_token');
  const expiresAt = parseInt(localStorage.getItem('token_expires_at') || '0');
  
  // æ£€æŸ¥ Token æ˜¯å¦å³å°†è¿‡æœŸï¼ˆæå‰5åˆ†é’Ÿåˆ·æ–°ï¼‰
  if (Date.now() >= expiresAt - 5 * 60 * 1000) {
    accessToken = await refreshAccessToken();
  }
  
  if (!accessToken) {
    // è·³è½¬åˆ°ç™»å½•é¡µ
    window.location.href = '/login';
    throw new Error('æœªç™»å½•');
  }
  
  return fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json',
    },
  });
}
```

## ğŸ” æƒé™é…ç½®

### è§’è‰²å±‚çº§

- `user` - æ™®é€šç”¨æˆ·ï¼ˆæƒé™ç­‰çº§ï¼š1ï¼‰
- `admin` - ç®¡ç†å‘˜ï¼ˆæƒé™ç­‰çº§ï¼š2ï¼‰
- `super_admin` - è¶…çº§ç®¡ç†å‘˜ï¼ˆæƒé™ç­‰çº§ï¼š3ï¼‰

### æƒé™ç‚¹æ˜ å°„

é»˜è®¤æƒé™æ˜ å°„ï¼ˆå¯åœ¨ `src/utils/jwt_utils.py` ä¸­æ‰©å±•ï¼‰ï¼š

```python
role_permissions = {
    'super_admin': ['*'],  # æ‹¥æœ‰æ‰€æœ‰æƒé™
    'admin': ['user:read', 'user:write', 'article:read', 'article:write'],
    'user': ['article:read', 'user:read']
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Token å®‰å…¨**
   - Access Token åº”å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ˆå¦‚ Vue çš„å“åº”å¼æ•°æ®ï¼‰ï¼Œé¿å…å­˜å‚¨åœ¨ localStorage
   - Refresh Token å¯ä»¥å­˜å‚¨åœ¨ httpOnly cookie ä¸­ï¼ˆæ›´å®‰å…¨ï¼‰

2. **Token åˆ·æ–°**
   - å‰ç«¯åº”è¯¥æ£€æµ‹ 401 å“åº”ï¼Œè‡ªåŠ¨å°è¯•åˆ·æ–° Token
   - å¦‚æœåˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ

3. **CSRF Token**
   - å¯¹äºæ•æ„Ÿæ“ä½œï¼ˆPOSTã€PUTã€DELETEï¼‰ï¼Œåº”è¯¥æºå¸¦ CSRF Token
   - CSRF Token åº”è¯¥ä¸ç”¨æˆ·ä¼šè¯å…³è”

4. **ç”Ÿäº§ç¯å¢ƒ**
   - å¿…é¡»ä¿®æ”¹ `SECRET_KEY`
   - è®¾ç½®åˆç†çš„ Token è¿‡æœŸæ—¶é—´
   - å¯ç”¨ HTTPS

## ğŸ“š ç›¸å…³æ–‡ä»¶

- JWT å·¥å…·ï¼š`src/utils/jwt_utils.py`
- è®¤è¯ä¸­é—´ä»¶ï¼š`src/middleware/auth_middleware.py`
- è®¤è¯è·¯ç”±ï¼š`src/routes/auth.py`
- ç”¨æˆ·è·¯ç”±ï¼š`src/routes/user.py`

