# ç‰¹å¾æ•°æ®å¤ç”¨åˆ†æ

## ğŸ¤” é—®é¢˜ï¼šé€‰æ‹©æ€§å­˜å‚¨åï¼Œç¬¬äºŒæ¬¡ç­›æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç”Ÿæˆç‰¹å¾æ•°æ®ï¼Ÿ

### æƒ…å†µåˆ†æ

#### æƒ…å†µ1ï¼šå®Œå…¨å­˜å‚¨æ‰€æœ‰ç‰¹å¾æ•°æ®

**å­˜å‚¨å†…å®¹**ï¼š
- `cleaned_content`ï¼ˆæ¸…æ´—åçš„å†…å®¹ï¼‰
- `content_hash`ï¼ˆå“ˆå¸Œå€¼ï¼‰
- `ngram_json`ï¼ˆN-gramç‰¹å¾ï¼‰
- `minhash_json`ï¼ˆMinHashæŒ‡çº¹ï¼‰

**ç¬¬äºŒæ¬¡ç­›æŸ¥æ—¶**ï¼š
1. âœ… **å¯ä»¥å¤ç”¨ç‰¹å¾æ•°æ®**
2. æŸ¥è¯¢ `question_dedup_features` è¡¨ï¼ŒæŸ¥æ‰¾è¯¥é¢˜ç›®çš„ç‰¹å¾è®°å½•
3. æ¯”è¾ƒ `content_hash` åˆ¤æ–­é¢˜ç›®å†…å®¹æ˜¯å¦å˜åŒ–
4. å¦‚æœ `content_hash` ç›¸åŒ â†’ ç›´æ¥ä½¿ç”¨å­˜å‚¨çš„ç‰¹å¾æ•°æ®
5. å¦‚æœ `content_hash` ä¸åŒ â†’ é‡æ–°è®¡ç®—ç‰¹å¾æ•°æ®

**ä¼˜ç‚¹**ï¼š
- å¯ä»¥å¤ç”¨ï¼ŒèŠ‚çœè®¡ç®—æ—¶é—´
- ç‰¹åˆ«é€‚åˆé¢˜ç›®å†…å®¹å˜åŒ–ä¸é¢‘ç¹çš„åœºæ™¯

**ç¼ºç‚¹**ï¼š
- å­˜å‚¨ç©ºé—´å¤§
- éœ€è¦åˆ¤æ–­å†…å®¹æ˜¯å¦å˜åŒ–

---

#### æƒ…å†µ2ï¼šé€‰æ‹©æ€§å­˜å‚¨ï¼ˆåªå­˜å‚¨éƒ¨åˆ†ç‰¹å¾ï¼‰

**å‡è®¾åªå­˜å‚¨**ï¼š
- `cleaned_content`ï¼ˆæ¸…æ´—åçš„å†…å®¹ï¼‰
- `content_hash`ï¼ˆå“ˆå¸Œå€¼ï¼‰
- âŒ ä¸å­˜å‚¨ `ngram_json` å’Œ `minhash_json`

**ç¬¬äºŒæ¬¡ç­›æŸ¥æ—¶**ï¼š
1. âŒ **ä»ç„¶éœ€è¦é‡æ–°ç”Ÿæˆéƒ¨åˆ†ç‰¹å¾æ•°æ®**
2. å¯ä»¥å¤ç”¨ï¼š`cleaned_content` å’Œ `content_hash`ï¼ˆå¦‚æœå†…å®¹æ²¡å˜ï¼‰
3. éœ€è¦é‡æ–°è®¡ç®—ï¼š`ngram_json` å’Œ `minhash_json`ï¼ˆå› ä¸ºæ²¡å­˜å‚¨ï¼‰

**ç»“è®º**ï¼š
- **æ˜¯çš„ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆç‰¹å¾æ•°æ®**ï¼ˆè‡³å°‘æ˜¯ N-gram å’Œ MinHashï¼‰
- åªèƒ½èŠ‚çœæ¸…æ´—å†…å®¹çš„è®¡ç®—æ—¶é—´

---

#### æƒ…å†µ3ï¼šå®Œå…¨ä¸å­˜å‚¨ç‰¹å¾æ•°æ®

**å­˜å‚¨å†…å®¹**ï¼š
- âŒ ä¸å­˜å‚¨ä»»ä½•ç‰¹å¾æ•°æ®

**ç¬¬äºŒæ¬¡ç­›æŸ¥æ—¶**ï¼š
1. âŒ **å¿…é¡»é‡æ–°ç”Ÿæˆæ‰€æœ‰ç‰¹å¾æ•°æ®**
2. æ¯æ¬¡éƒ½éœ€è¦å®Œæ•´è®¡ç®—æ‰€æœ‰æ­¥éª¤

---

## ğŸ’¡ å…³é”®è€ƒè™‘å› ç´ 

### 1. é¢˜ç›®å†…å®¹æ˜¯å¦ä¼šå˜åŒ–ï¼Ÿ

**å¦‚æœé¢˜ç›®å†…å®¹ä¼šå˜åŒ–**ï¼š
- å³ä½¿å­˜å‚¨äº†ç‰¹å¾æ•°æ®ï¼Œä¹Ÿéœ€è¦åˆ¤æ–­å†…å®¹æ˜¯å¦å˜åŒ–
- é€šè¿‡ `content_hash` æ¯”è¾ƒ
- å¦‚æœå˜åŒ–äº†ï¼Œä»éœ€é‡æ–°è®¡ç®—

**å¦‚æœé¢˜ç›®å†…å®¹ä¸å˜**ï¼š
- å­˜å‚¨çš„ç‰¹å¾æ•°æ®å¯ä»¥å®Œå…¨å¤ç”¨
- èŠ‚çœå¤§é‡è®¡ç®—æ—¶é—´

### 2. è®¡ç®—æˆæœ¬ vs å­˜å‚¨æˆæœ¬

**N-gram å’Œ MinHash çš„è®¡ç®—æˆæœ¬**ï¼š
- N-gramï¼šç›¸å¯¹è¾ƒå¿«ï¼ˆO(n)ï¼Œnä¸ºæ–‡æœ¬é•¿åº¦ï¼‰
- MinHashï¼šç›¸å¯¹è¾ƒæ…¢ï¼ˆéœ€è¦128æ¬¡å“ˆå¸Œè®¡ç®—ï¼‰
- ä½†å¯¹äº50ä¸‡é¢˜ç›®ï¼Œé‡æ–°è®¡ç®—ä»éœ€è¦ä¸€å®šæ—¶é—´

**å­˜å‚¨æˆæœ¬**ï¼š
- `ngram_json`ï¼šä¸€ä¸ªé¢˜ç›®å¯èƒ½æœ‰å‡ ç™¾ä¸ªn-gramç‰‡æ®µï¼ŒJSONå­—ç¬¦ä¸²å¯èƒ½å‡ KB
- `minhash_json`ï¼š128ä¸ªæ•´æ•°ï¼ŒJSONå­—ç¬¦ä¸²çº¦1KB
- 50ä¸‡é¢˜ç›®ï¼šæ€»å­˜å‚¨é‡å¯èƒ½å‡ GB

### 3. å®é™…ä½¿ç”¨åœºæ™¯

**å¦‚æœç»å¸¸éœ€è¦é‡æ–°ç­›æŸ¥**ï¼š
- å­˜å‚¨ç‰¹å¾æ•°æ®æ›´åˆ’ç®—ï¼ˆå¯ä»¥å¤ç”¨ï¼‰
- èŠ‚çœè®¡ç®—æ—¶é—´

**å¦‚æœå¶å°”ç­›æŸ¥ä¸€æ¬¡**ï¼š
- å¯èƒ½ä¸å­˜å‚¨æ›´åˆ’ç®—ï¼ˆèŠ‚çœå­˜å‚¨ç©ºé—´ï¼‰
- é‡æ–°è®¡ç®—çš„æ—¶é—´æˆæœ¬å¯ä»¥æ¥å—

---

## ğŸ¯ å»ºè®®æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šå®Œå…¨å­˜å‚¨ + æ™ºèƒ½å¤ç”¨ï¼ˆæ¨èç”¨äºé¢‘ç¹ç­›æŸ¥ï¼‰

**å­˜å‚¨ç­–ç•¥**ï¼š
- å­˜å‚¨æ‰€æœ‰ç‰¹å¾æ•°æ®ï¼ˆcleaned_content, content_hash, ngram_json, minhash_jsonï¼‰

**å¤ç”¨é€»è¾‘**ï¼š
```python
# ä¼ªä»£ç 
def get_or_compute_features(question_id, current_content):
    # 1. æŸ¥è¯¢æ˜¯å¦æœ‰è¯¥é¢˜ç›®çš„ç‰¹å¾è®°å½•
    feature = QuestionDedupFeature.query.filter_by(
        question_id=question_id,
        task_id=previous_task_id  # æˆ–æŸ¥è¯¢æœ€æ–°çš„ä»»åŠ¡
    ).first()
    
    if feature:
        # 2. è®¡ç®—å½“å‰å†…å®¹çš„å“ˆå¸Œå€¼
        current_hash = md5(clean_content(current_content))
        
        # 3. æ¯”è¾ƒå“ˆå¸Œå€¼
        if feature.content_hash == current_hash:
            # å†…å®¹æ²¡å˜ï¼Œç›´æ¥å¤ç”¨
            return {
                'cleaned_content': feature.cleaned_content,
                'ngrams': feature.get_ngrams(),
                'minhash': feature.get_minhash()
            }
    
    # 4. å†…å®¹å˜åŒ–æˆ–æ²¡æœ‰è®°å½•ï¼Œé‡æ–°è®¡ç®—
    return compute_features(current_content)
```

**ä¼˜ç‚¹**ï¼š
- å¯ä»¥å¤ç”¨ï¼ŒèŠ‚çœè®¡ç®—æ—¶é—´
- ç‰¹åˆ«é€‚åˆå†…å®¹å˜åŒ–ä¸é¢‘ç¹çš„åœºæ™¯

**ç¼ºç‚¹**ï¼š
- å­˜å‚¨ç©ºé—´å¤§

---

### æ–¹æ¡ˆBï¼šé€‰æ‹©æ€§å­˜å‚¨ + éƒ¨åˆ†å¤ç”¨ï¼ˆæ¨èç”¨äºå¶å°”ç­›æŸ¥ï¼‰

**å­˜å‚¨ç­–ç•¥**ï¼š
- åªå­˜å‚¨ `cleaned_content` å’Œ `content_hash`
- ä¸å­˜å‚¨ `ngram_json` å’Œ `minhash_json`

**å¤ç”¨é€»è¾‘**ï¼š
```python
def get_or_compute_features(question_id, current_content):
    feature = QuestionDedupFeature.query.filter_by(
        question_id=question_id
    ).first()
    
    if feature:
        current_hash = md5(clean_content(current_content))
        if feature.content_hash == current_hash:
            # å†…å®¹æ²¡å˜ï¼Œå¯ä»¥å¤ç”¨æ¸…æ´—åçš„å†…å®¹
            cleaned_content = feature.cleaned_content
        else:
            # å†…å®¹å˜åŒ–ï¼Œé‡æ–°æ¸…æ´—
            cleaned_content = clean_content(current_content)
    else:
        cleaned_content = clean_content(current_content)
    
    # N-gram å’Œ MinHash æ€»æ˜¯éœ€è¦é‡æ–°è®¡ç®—
    ngrams = extract_ngrams(cleaned_content)
    minhash = generate_minhash(ngrams)
    
    return {
        'cleaned_content': cleaned_content,
        'ngrams': ngrams,
        'minhash': minhash
    }
```

**ä¼˜ç‚¹**ï¼š
- å­˜å‚¨ç©ºé—´è¾ƒå°
- å¯ä»¥å¤ç”¨æ¸…æ´—æ­¥éª¤ï¼ˆèŠ‚çœéƒ¨åˆ†æ—¶é—´ï¼‰

**ç¼ºç‚¹**ï¼š
- ä»ç„¶éœ€è¦é‡æ–°è®¡ç®— N-gram å’Œ MinHash

---

### æ–¹æ¡ˆCï¼šä¸å­˜å‚¨ + æ¯æ¬¡é‡æ–°è®¡ç®—ï¼ˆæ¨èç”¨äºå¶å°”ç­›æŸ¥ï¼‰

**å­˜å‚¨ç­–ç•¥**ï¼š
- å®Œå…¨ä¸å­˜å‚¨ç‰¹å¾æ•°æ®

**å¤„ç†é€»è¾‘**ï¼š
- æ¯æ¬¡ç­›æŸ¥éƒ½é‡æ–°è®¡ç®—æ‰€æœ‰ç‰¹å¾æ•°æ®

**ä¼˜ç‚¹**ï¼š
- å­˜å‚¨ç©ºé—´æœ€å°
- é€»è¾‘ç®€å•

**ç¼ºç‚¹**ï¼š
- æ¯æ¬¡éƒ½éœ€è¦å®Œæ•´è®¡ç®—
- è®¡ç®—æ—¶é—´è¾ƒé•¿

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”ï¼ˆä¼°ç®—ï¼‰

å‡è®¾50ä¸‡é¢˜ç›®ï¼ŒN-gramè®¡ç®—çº¦0.1ms/é¢˜ï¼ŒMinHashè®¡ç®—çº¦0.5ms/é¢˜ï¼š

| æ–¹æ¡ˆ | å­˜å‚¨ç©ºé—´ | ç¬¬ä¸€æ¬¡ç­›æŸ¥ | ç¬¬äºŒæ¬¡ç­›æŸ¥ï¼ˆå†…å®¹æœªå˜ï¼‰ | ç¬¬äºŒæ¬¡ç­›æŸ¥ï¼ˆå†…å®¹å˜åŒ–ï¼‰ |
|------|---------|-----------|---------------------|---------------------|
| å®Œå…¨å­˜å‚¨ | å¤§ï¼ˆå‡ GBï¼‰ | æ­£å¸¸ | **å¿«é€Ÿï¼ˆå¤ç”¨ï¼‰** | æ­£å¸¸ |
| é€‰æ‹©æ€§å­˜å‚¨ | ä¸­ï¼ˆå‡ ç™¾MBï¼‰ | æ­£å¸¸ | è¾ƒå¿«ï¼ˆéƒ¨åˆ†å¤ç”¨ï¼‰ | æ­£å¸¸ |
| ä¸å­˜å‚¨ | å°ï¼ˆ0ï¼‰ | æ­£å¸¸ | æ­£å¸¸ï¼ˆé‡æ–°è®¡ç®—ï¼‰ | æ­£å¸¸ |

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

æ ¹æ®æ‚¨çš„ä½¿ç”¨åœºæ™¯ï¼š

1. **å¦‚æœä¼šé¢‘ç¹é‡æ–°ç­›æŸ¥ï¼ˆå¦‚æ¯å‘¨/æ¯æœˆï¼‰**ï¼š
   - æ¨èï¼š**æ–¹æ¡ˆAï¼ˆå®Œå…¨å­˜å‚¨ï¼‰**
   - å¯ä»¥æ˜¾è‘—èŠ‚çœåç»­ç­›æŸ¥æ—¶é—´

2. **å¦‚æœå¶å°”ç­›æŸ¥ï¼ˆå¦‚å‡ ä¸ªæœˆä¸€æ¬¡ï¼‰**ï¼š
   - æ¨èï¼š**æ–¹æ¡ˆBï¼ˆé€‰æ‹©æ€§å­˜å‚¨ï¼‰** æˆ– **æ–¹æ¡ˆCï¼ˆä¸å­˜å‚¨ï¼‰**
   - æ ¹æ®å­˜å‚¨æˆæœ¬æƒè¡¡

3. **å¦‚æœé¢˜ç›®å†…å®¹ç»å¸¸å˜åŒ–**ï¼š
   - æ¨èï¼š**æ–¹æ¡ˆCï¼ˆä¸å­˜å‚¨ï¼‰**
   - å› ä¸ºå³ä½¿å­˜å‚¨äº†ï¼Œä¹Ÿç»å¸¸éœ€è¦é‡æ–°è®¡ç®—

---

**å›ç­”æ‚¨çš„é—®é¢˜**ï¼š

å¦‚æœé€‰æ‹©é€‰æ‹©æ€§å­˜å‚¨ï¼ˆåªå­˜å‚¨ cleaned_content å’Œ content_hashï¼‰ï¼Œé‚£ä¹ˆï¼š
- âœ… **å¯ä»¥å¤ç”¨æ¸…æ´—åçš„å†…å®¹**ï¼ˆå¦‚æœå†…å®¹æ²¡å˜ï¼‰
- âŒ **ä»ç„¶éœ€è¦é‡æ–°ç”Ÿæˆ N-gram å’Œ MinHash ç‰¹å¾æ•°æ®**
- ğŸ’¡ åªèƒ½èŠ‚çœæ¸…æ´—æ­¥éª¤çš„æ—¶é—´ï¼Œæ— æ³•èŠ‚çœç‰¹å¾æå–çš„æ—¶é—´

å¦‚æœæƒ³å®Œå…¨å¤ç”¨ç‰¹å¾æ•°æ®ï¼Œå»ºè®®å­˜å‚¨å®Œæ•´çš„ç‰¹å¾æ•°æ®ï¼ˆåŒ…æ‹¬ ngram_json å’Œ minhash_jsonï¼‰ã€‚

