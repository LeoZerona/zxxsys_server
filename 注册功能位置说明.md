# 注册功能代码位置说明

## 📍 核心文件位置

### 1. **注册接口路由** - `src/app.py`

**位置**：`src/app.py` 第 212-377 行

**主要函数**：

- `@app.route('/api/register', methods=['POST'])` - 注册接口路由
- `def register()` - 注册处理函数

**功能**：

- ✅ 接收注册请求（邮箱、密码、验证码）
- ✅ 验证邮箱格式
- ✅ 验证密码
- ✅ 验证验证码
- ✅ 检查邮箱是否已存在
- ✅ 创建新用户
- ✅ 返回注册结果

---

### 2. **数据模型** - `src/models.py`

**位置**：`src/models.py`

**相关类**：

- `User` 类（第 9-97 行）- 用户数据模型

  - `set_password()` - 设置密码（支持 MD5 和明文）
  - `check_password()` - 验证密码
  - `to_dict()` - 转换为字典
  - `is_md5_hash()` - 检查是否为 MD5 哈希值

- `EmailVerification` 类（第 100-119 行）- 邮箱验证码模型

---

### 3. **邮箱验证码服务** - `src/email_service.py`

**位置**：`src/email_service.py`

**相关函数**：

- `verify_code(email, code)` - 验证验证码（第 249-327 行）

  - 检查验证码是否正确
  - 检查验证码是否过期
  - 检查验证码和邮箱是否匹配
  - 检查是否使用最新验证码
  - 标记验证码为已使用

- `send_verification_code(email)` - 发送验证码（第 125-247 行）
  - 生成验证码
  - 保存验证码到数据库
  - 发送邮件

---

### 4. **配置文件** - `src/config.py`

**位置**：`src/config.py`

**相关配置**：

- `EMAIL_REGEX` - 邮箱格式正则表达式（第 88 行）
- `MIN_PASSWORD_LENGTH` - 最小密码长度（第 91 行）
- `VERIFICATION_CODE_EXPIRE_MINUTES` - 验证码过期时间（第 104 行）
- `DEFAULT_USER_ROLE` - 默认用户角色（第 113 行）
- `UNIVERSAL_VERIFICATION_CODE` - 万能验证码（测试用，第 82-85 行）

---

## 📂 文件结构

```
src/
├── app.py              # 注册接口路由和处理逻辑 ⭐
├── models.py           # User 和 EmailVerification 模型
├── email_service.py    # 验证码验证和发送服务
└── config.py           # 配置（邮箱格式、密码长度等）
```

---

## 🔍 代码流程图

### 注册流程

```
客户端请求
    ↓
src/app.py: register() 函数
    ↓
1. 验证邮箱格式 (Config.EMAIL_REGEX)
    ↓
2. 验证密码 (User.is_md5_hash(), 长度检查)
    ↓
3. 验证验证码 (email_service.verify_code())
    ├─ 检查验证码是否存在
    ├─ 检查验证码和邮箱是否匹配
    ├─ 检查验证码是否过期
    └─ 检查是否使用最新验证码
    ↓
4. 检查邮箱是否已存在 (User.query.filter_by())
    ↓
5. 创建用户 (User.set_password())
    ↓
6. 保存到数据库 (db.session.add(), commit())
    ↓
返回结果
```

---

## 📝 关键代码片段

### 注册接口路由

**文件**：`src/app.py` 第 212 行

```python
@app.route('/api/register', methods=['POST'])
def register():
    """邮箱注册接口"""
    # 1. 获取请求数据
    # 2. 验证邮箱格式
    # 3. 验证密码
    # 4. 验证验证码
    # 5. 检查邮箱是否已存在
    # 6. 创建新用户
    # 7. 返回结果
```

### 用户模型

**文件**：`src/models.py` 第 9 行

```python
class User(db.Model):
    """用户模型"""
    id = db.Column(...)
    email = db.Column(...)
    password_hash = db.Column(...)
    role = db.Column(...)
    # ...

    def set_password(self, password):
        """设置密码（支持MD5和明文）"""

    def check_password(self, password):
        """验证密码"""
```

### 验证码验证

**文件**：`src/email_service.py` 第 249 行

```python
def verify_code(email, code):
    """验证验证码"""
    # 1. 检查万能验证码
    # 2. 查询数据库中的验证码
    # 3. 检查验证码和邮箱是否匹配
    # 4. 检查是否过期
    # 5. 检查是否使用最新验证码
    # 6. 标记为已使用
```

---

## 🧪 测试文件

### 注册功能测试

**位置**：

- `scripts/test/test_register_api.py` - 完整的注册功能测试
- `快速测试用户注册.py` - 快速测试脚本
- `测试注册安全功能.py` - 安全功能测试

---

## 📚 相关文档

- API 文档：`docs/api/API.md`
- 前端对接文档：`docs/api/前端对接文档.md`
- 安全清单：`注册功能安全检查清单.md`

---

## 🎯 快速查找

### 想修改注册逻辑？

**修改**：`src/app.py` 的 `register()` 函数（第 212-377 行）

### 想修改用户模型？

**修改**：`src/models.py` 的 `User` 类（第 9-97 行）

### 想修改验证码验证逻辑？

**修改**：`src/email_service.py` 的 `verify_code()` 函数（第 249-327 行）

### 想修改配置（密码长度、验证码过期时间等）？

**修改**：`src/config.py`

---

## 📍 总结

**注册功能的核心代码在 `src/app.py` 文件中，具体是 `register()` 函数（第 212 行开始）**。

其他相关文件：

- `src/models.py` - 用户数据模型
- `src/email_service.py` - 验证码验证逻辑
- `src/config.py` - 配置文件
