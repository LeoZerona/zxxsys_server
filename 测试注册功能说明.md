# 测试用户注册功能说明

## 🧪 测试方法

### 方法一：使用快速测试脚本（推荐）

创建一个简单的测试脚本 `快速测试用户注册.py`，运行：

```bash
python 快速测试用户注册.py
```

**功能**：
- ✅ 自动生成测试邮箱和密码
- ✅ 发送注册请求
- ✅ 验证数据库中的数据
- ✅ 显示详细的测试结果

### 方法二：使用完整的测试脚本

运行完整的测试脚本：

```bash
python scripts/test/test_register_api.py
```

**功能**：
- ✅ 测试 MD5 密码注册
- ✅ 测试明文密码注册
- ✅ 测试重复邮箱注册（应该失败）
- ✅ 查询并显示数据库中的所有用户

### 方法三：手动测试（使用 curl 或 Postman）

#### 1. 发送注册请求

**curl 命令**：
```bash
curl -X POST http://localhost:5000/api/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "test123456",
    "verification_code": "123456"
  }'
```

**Postman**：
- Method: POST
- URL: `http://localhost:5000/api/register`
- Headers: `Content-Type: application/json`
- Body (raw JSON):
```json
{
  "email": "test@example.com",
  "password": "test123456",
  "verification_code": "123456"
}
```

#### 2. 验证数据库

运行查询脚本：

```bash
python scripts/utils/query_users.py
```

或

```bash
python scripts/utils/查询MySQL用户表.py
```

### 方法四：使用单元测试

运行 pytest 单元测试：

```bash
pytest tests/test_api.py::TestRegisterAPI -v
```

## 📋 测试前准备

### 1. 启动 Flask 应用

```bash
python app.py
```

确保应用在 `http://localhost:5000` 运行。

### 2. 确认数据库配置

检查数据库配置是否正确：

```bash
python scripts/utils/check_database_config.py
```

### 3. 确认验证码设置

开发环境默认使用万能验证码 `123456`，无需发送真实邮件。

## ✅ 预期结果

### 注册成功

**HTTP 响应**：
- 状态码: `201 Created`
- 响应体:
```json
{
  "message": "注册成功",
  "user": {
    "id": 1,
    "email": "test@example.com",
    "role": "user",
    "created_at": "2024-01-01T12:00:00",
    "is_active": true
  }
}
```

**数据库验证**：
- ✅ 用户数据已写入 `users` 表
- ✅ 密码已加密存储
- ✅ `role` 字段默认为 `user`
- ✅ `created_at` 和 `updated_at` 已设置

### 注册失败（重复邮箱）

**HTTP 响应**：
- 状态码: `409 Conflict`
- 响应体:
```json
{
  "error": "该邮箱已被注册"
}
```

## 🔍 验证数据库数据

### 使用查询脚本

```bash
# 查询所有用户
python scripts/utils/query_users.py

# 查询 MySQL 用户表
python scripts/utils/查询MySQL用户表.py
```

### 直接查询数据库

**MySQL**：
```sql
SELECT * FROM users ORDER BY created_at DESC;
```

**SQLite**：
```sql
SELECT * FROM users ORDER BY created_at DESC;
```

## 🐛 常见问题

### 1. 连接失败

**错误**: `连接失败: 请确保 Flask 应用正在运行`

**解决**: 确保 Flask 应用已启动：
```bash
python app.py
```

### 2. 验证码错误

**错误**: `验证码错误` 或 `验证码已过期`

**解决**: 
- 开发环境使用万能验证码 `123456`
- 或先调用发送验证码接口获取验证码

### 3. 数据库连接失败

**错误**: `数据库连接失败`

**解决**:
- 检查数据库配置
- 确保 MySQL 服务运行（如果使用 MySQL）
- 检查数据库和表是否存在

### 4. 密码格式错误

**错误**: `密码长度不足`

**解决**: 
- 密码长度至少 6 位
- 如果使用 MD5 哈希，应该是 32 位十六进制字符串

## 📝 测试检查清单

- [ ] Flask 应用已启动
- [ ] 数据库连接正常
- [ ] 测试脚本可以运行
- [ ] 注册请求成功（201 状态码）
- [ ] 数据库中可以看到新用户
- [ ] 密码正确加密存储
- [ ] 重复邮箱注册被拒绝（409 状态码）
- [ ] 用户信息完整（id、email、role、时间戳等）

## 🎯 快速开始

1. **启动应用**:
   ```bash
   python app.py
   ```

2. **运行测试** (新终端窗口):
   ```bash
   python 快速测试用户注册.py
   ```

3. **查看结果**: 测试脚本会显示详细的测试结果和数据库验证信息

