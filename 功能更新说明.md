# 功能更新说明

## 📋 本次更新内容

### 1. ✅ 添加用户权限字段

**实现位置**：
- `models.py` - User 模型新增 `role` 字段

**权限类型**：
- `super_admin` - 超级管理员（最高权限）
- `admin` - 管理员
- `user` - 普通用户（默认）

**新增方法**：
- `has_permission(required_role)` - 检查用户是否有指定权限
- `is_super_admin()` - 检查是否为超级管理员
- `is_admin()` - 检查是否为管理员（包括超级管理员）

**使用示例**：
```python
user = User.query.first()

# 检查权限
if user.has_permission('admin'):
    # 执行管理员操作

if user.is_super_admin():
    # 执行超级管理员操作
```

---

### 2. ✅ 验证码发送频率限制

**功能**：每个邮箱 1 分钟内只能获取一次验证码

**实现位置**：
- `email_service.py` - `send_verification_code()` 函数

**逻辑**：
1. 检查该邮箱上次发送验证码的时间
2. 如果距离上次发送不足 1 分钟，拒绝发送
3. 返回剩余等待时间（秒数）

**响应示例**（频率限制时）：
```json
{
  "success": false,
  "message": "发送验证码过于频繁，请等待 30秒 后再试",
  "cooldown_seconds": 30
}
```

**配置**：
- `config.py` 中的 `VERIFICATION_CODE_COOLDOWN_MINUTES = 1`

---

### 3. ✅ 注册时验证码时效性检查

**功能**：注册时检查验证码是否在有效期内（10分钟）

**实现位置**：
- `app.py` - `/api/register` 接口
- `email_service.py` - `verify_code()` 函数

**逻辑**：
1. 注册时必须提供验证码
2. 验证码必须有效且未使用
3. 验证码必须在有效期内（10分钟内）
4. 超过有效期会返回提示信息

**注册接口更新**：

**请求参数**（新增）：
- `verification_code` - 邮箱验证码（必填）

**请求示例**：
```json
{
  "email": "user@example.com",
  "password": "password123",
  "verification_code": "123456"
}
```

**响应示例**（验证码过期）：
```json
{
  "success": false,
  "message": "验证码已过期，请重新获取"
}
```

---

## 📊 API 接口变更

### 注册接口变更

**变更前**：
```json
POST /api/register
{
  "email": "user@example.com",
  "password": "password123"
}
```

**变更后**：
```json
POST /api/register
{
  "email": "user@example.com",
  "password": "password123",
  "verification_code": "123456"  // 新增：验证码（必填）
}
```

---

## 🔧 数据库变更

### users 表新增字段

```sql
ALTER TABLE users ADD COLUMN role VARCHAR(20) DEFAULT 'user' NOT NULL;
CREATE INDEX idx_users_role ON users(role);
```

**字段说明**：
- `role` - 用户权限
  - 类型：VARCHAR(20)
  - 默认值：'user'
  - 允许值：'super_admin', 'admin', 'user'

---

## 📝 配置更新

### config.py 新增配置

```python
# 验证码发送冷却时间（分钟）
VERIFICATION_CODE_COOLDOWN_MINUTES = 1

# 用户权限配置
USER_ROLES = {
    'super_admin': '超级管理员',
    'admin': '管理员',
    'user': '普通用户'
}
DEFAULT_USER_ROLE = 'user'  # 默认用户权限
```

---

## 🚀 数据库迁移

### 方式 1: 使用 SQL（推荐）

执行 SQL 文件：
```bash
sqlite3 app.db < update_users_table_add_role.sql
```

或手动执行：
```sql
ALTER TABLE users ADD COLUMN role VARCHAR(20) DEFAULT 'user' NOT NULL;
CREATE INDEX idx_users_role ON users(role);
```

### 方式 2: 重新创建表

如果是新项目或测试环境，可以直接重新创建：
```bash
python init_db.py
```

### 方式 3: 使用迁移脚本

```bash
python migrate_add_user_role.py
```

---

## 📋 使用示例

### 前端注册流程

```typescript
// 1. 发送验证码
const sendCodeResponse = await fetch('/api/send-verification-code', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email: 'user@example.com' })
});

// 如果频繁发送，会收到：
// { success: false, message: "发送验证码过于频繁，请等待 30秒 后再试", cooldown_seconds: 30 }

// 2. 用户输入验证码后注册
const registerResponse = await fetch('/api/register', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'user@example.com',
    password: 'password123',
    verification_code: '123456'  // 新增：验证码
  })
});

// 如果验证码过期，会收到：
// { success: false, message: "验证码已过期，请重新获取" }
```

---

## ⚠️ 注意事项

1. **数据库迁移**
   - 如果已有 users 表，需要执行迁移 SQL
   - 新项目可直接运行 `init_db.py`

2. **验证码流程**
   - 注册时必须提供验证码
   - 验证码 1 分钟内只能获取一次
   - 验证码有效期 10 分钟

3. **用户权限**
   - 新用户默认权限为 `user`（普通用户）
   - 需要通过管理接口修改用户权限

4. **兼容性**
   - 旧版本的注册接口（不带验证码）将无法使用
   - 前端需要更新注册流程

---

## 📚 相关文件

- `models.py` - 用户模型（添加 role 字段）
- `app.py` - 注册接口（添加验证码验证）
- `email_service.py` - 验证码服务（添加频率限制）
- `config.py` - 配置（添加权限和频率配置）
- `update_users_table_add_role.sql` - 数据库迁移 SQL
- `migrate_add_user_role.py` - 迁移脚本

---

## 🧪 测试建议

1. **测试验证码频率限制**
   - 连续发送两次验证码
   - 验证第二次被拒绝，显示等待时间

2. **测试验证码时效性**
   - 发送验证码后等待 11 分钟
   - 尝试注册，应该提示过期

3. **测试用户权限**
   - 注册新用户，检查默认权限为 `user`
   - 验证权限检查方法

---

## 🔄 下一步建议

1. 创建管理员接口（修改用户权限）
2. 实现基于权限的菜单返回接口
3. 添加 JWT 认证，在 token 中包含权限信息
4. 实现权限中间件，自动检查 API 权限

