# å‰ç«¯å¯¹æ¥æ–‡æ¡£

## ğŸ“‹ æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®

### åç«¯æœåŠ¡åœ°å€

```
http://localhost:5000
```

### API åŸºç¡€è·¯å¾„

```
http://localhost:5000/api
```

---

## ğŸ”Œ API æ¥å£åˆ—è¡¨

### 1. å‘é€éªŒè¯ç 

**æ¥å£åœ°å€**: `POST /api/send-verification-code`

**è¯·æ±‚å¤´**:
```
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**:
```json
{
  "email": "user@example.com"
}
```

**æˆåŠŸå“åº”** (200):
```json
{
  "success": true,
  "message": "éªŒè¯ç å·²å‘é€",
  "code": "123456"  // ä»…æµ‹è¯•æ¨¡å¼è¿”å›ï¼Œç”Ÿäº§ç¯å¢ƒä¸è¿”å›
}
```

**é”™è¯¯å“åº”**:

- é¢‘ç‡é™åˆ¶ (429):
```json
{
  "success": false,
  "message": "å‘é€éªŒè¯ç è¿‡äºé¢‘ç¹ï¼Œè¯·ç­‰å¾… 30ç§’ åå†è¯•",
  "cooldown_seconds": 30
}
```

- é‚®ç®±æ ¼å¼é”™è¯¯ (400):
```json
{
  "success": false,
  "message": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
}
```

---

### 2. ç”¨æˆ·æ³¨å†Œ

**æ¥å£åœ°å€**: `POST /api/register`

**è¯·æ±‚å¤´**:
```
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**:
```json
{
  "email": "user@example.com",
  "password": "password123",
  "verification_code": "123456"
}
```

**æˆåŠŸå“åº”** (201):
```json
{
  "success": true,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "id": 1,
    "email": "user@example.com",
    "role": "user",
    "created_at": "2024-01-01T00:00:00",
    "is_active": true
  }
}
```

**é”™è¯¯å“åº”**:

- éªŒè¯ç ä¸ºç©º (400):
```json
{
  "success": false,
  "message": "éªŒè¯ç ä¸èƒ½ä¸ºç©º"
}
```

- éªŒè¯ç æ— æ•ˆ (400):
```json
{
  "success": false,
  "message": "éªŒè¯ç æ— æ•ˆ"
}
```

- éªŒè¯ç è¿‡æœŸ (400):
```json
{
  "success": false,
  "message": "éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–"
}
```

- é‚®ç®±å·²å­˜åœ¨ (409):
```json
{
  "success": false,
  "message": "è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ"
}
```

---

## ğŸ’» Vue3 + TypeScript è°ƒç”¨ç¤ºä¾‹

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ Fetch API

åˆ›å»ºæ–‡ä»¶ `src/api/auth.ts`:

```typescript
// API åŸºç¡€é…ç½®
const API_BASE_URL = 'http://localhost:5000/api'

// å“åº”ç±»å‹å®šä¹‰
interface ApiResponse<T = any> {
  success: boolean
  message: string
  data?: T
  code?: string  // ä»…æµ‹è¯•æ¨¡å¼
  cooldown_seconds?: number  // é¢‘ç‡é™åˆ¶æ—¶è¿”å›
}

interface SendCodeResponse extends ApiResponse {
  code?: string
  cooldown_seconds?: number
}

interface RegisterResponse extends ApiResponse {
  data?: {
    id: number
    email: string
    role: string
    created_at: string
    is_active: boolean
  }
}

// å‘é€éªŒè¯ç 
export async function sendVerificationCode(email: string): Promise<SendCodeResponse> {
  try {
    const response = await fetch(`${API_BASE_URL}/send-verification-code`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ email }),
    })

    const data: SendCodeResponse = await response.json()

    if (!response.ok) {
      throw new Error(data.message || 'è¯·æ±‚å¤±è´¥')
    }

    return data
  } catch (error) {
    console.error('å‘é€éªŒè¯ç å¤±è´¥:', error)
    throw error
  }
}

// ç”¨æˆ·æ³¨å†Œ
export async function register(
  email: string,
  password: string,
  verificationCode: string
): Promise<RegisterResponse> {
  try {
    const response = await fetch(`${API_BASE_URL}/register`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        email,
        password,
        verification_code: verificationCode,
      }),
    })

    const data: RegisterResponse = await response.json()

    if (!response.ok) {
      throw new Error(data.message || 'æ³¨å†Œå¤±è´¥')
    }

    return data
  } catch (error) {
    console.error('æ³¨å†Œå¤±è´¥:', error)
    throw error
  }
}
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ Axios

å®‰è£… Axios:
```bash
npm install axios
```

åˆ›å»ºæ–‡ä»¶ `src/api/auth.ts`:

```typescript
import axios, { AxiosResponse } from 'axios'

// åˆ›å»º axios å®ä¾‹
const api = axios.create({
  baseURL: 'http://localhost:5000/api',
  headers: {
    'Content-Type': 'application/json',
  },
  timeout: 10000,  // 10ç§’è¶…æ—¶
})

// å“åº”ç±»å‹å®šä¹‰
interface ApiResponse<T = any> {
  success: boolean
  message: string
  data?: T
  code?: string
  cooldown_seconds?: number
}

interface SendCodeResponse extends ApiResponse {
  code?: string
  cooldown_seconds?: number
}

interface RegisterResponse extends ApiResponse {
  data?: {
    id: number
    email: string
    role: string
    created_at: string
    is_active: boolean
  }
}

// å‘é€éªŒè¯ç 
export async function sendVerificationCode(email: string): Promise<SendCodeResponse> {
  try {
    const response: AxiosResponse<SendCodeResponse> = await api.post('/send-verification-code', {
      email,
    })
    return response.data
  } catch (error: any) {
    if (error.response) {
      // æœåŠ¡å™¨è¿”å›äº†é”™è¯¯å“åº”
      throw new Error(error.response.data?.message || 'å‘é€éªŒè¯ç å¤±è´¥')
    } else {
      throw new Error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨')
    }
  }
}

// ç”¨æˆ·æ³¨å†Œ
export async function register(
  email: string,
  password: string,
  verificationCode: string
): Promise<RegisterResponse> {
  try {
    const response: AxiosResponse<RegisterResponse> = await api.post('/register', {
      email,
      password,
      verification_code: verificationCode,
    })
    return response.data
  } catch (error: any) {
    if (error.response) {
      throw new Error(error.response.data?.message || 'æ³¨å†Œå¤±è´¥')
    } else {
      throw new Error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨')
    }
  }
}
```

---

## ğŸ¨ Vue3 ç»„ä»¶ä½¿ç”¨ç¤ºä¾‹

åˆ›å»ºæ³¨å†Œç»„ä»¶ `src/components/RegisterForm.vue`:

```vue
<template>
  <div class="register-form">
    <h2>ç”¨æˆ·æ³¨å†Œ</h2>
    
    <el-form :model="form" :rules="rules" ref="formRef" label-width="100px">
      <el-form-item label="é‚®ç®±" prop="email">
        <el-input v-model="form.email" placeholder="è¯·è¾“å…¥é‚®ç®±" />
      </el-form-item>
      
      <el-form-item label="å¯†ç " prop="password">
        <el-input 
          v-model="form.password" 
          type="password" 
          placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
          show-password
        />
      </el-form-item>
      
      <el-form-item label="éªŒè¯ç " prop="verificationCode">
        <div style="display: flex; gap: 10px;">
          <el-input 
            v-model="form.verificationCode" 
            placeholder="è¯·è¾“å…¥éªŒè¯ç "
            style="flex: 1;"
          />
          <el-button 
            :disabled="codeButtonDisabled || countdown > 0"
            @click="handleSendCode"
          >
            {{ countdown > 0 ? `${countdown}ç§’åé‡è¯•` : 'å‘é€éªŒè¯ç ' }}
          </el-button>
        </div>
        <div v-if="testCode" style="margin-top: 5px; color: #909399; font-size: 12px;">
          æµ‹è¯•æ¨¡å¼éªŒè¯ç : {{ testCode }}
        </div>
      </el-form-item>
      
      <el-form-item>
        <el-button type="primary" :loading="loading" @click="handleRegister">
          æ³¨å†Œ
        </el-button>
        <el-button @click="handleReset">é‡ç½®</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, computed } from 'vue'
import { ElMessage } from 'element-plus'
import { sendVerificationCode, register } from '@/api/auth'

// è¡¨å•æ•°æ®
const form = reactive({
  email: '',
  password: '',
  verificationCode: '',
})

// è¡¨å•éªŒè¯è§„åˆ™
const rules = {
  email: [
    { required: true, message: 'è¯·è¾“å…¥é‚®ç®±', trigger: 'blur' },
    { type: 'email', message: 'è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±æ ¼å¼', trigger: 'blur' },
  ],
  password: [
    { required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur' },
    { min: 6, message: 'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½', trigger: 'blur' },
  ],
  verificationCode: [
    { required: true, message: 'è¯·è¾“å…¥éªŒè¯ç ', trigger: 'blur' },
    { len: 6, message: 'éªŒè¯ç é•¿åº¦ä¸º6ä½', trigger: 'blur' },
  ],
}

const formRef = ref()
const loading = ref(false)
const codeButtonDisabled = ref(false)
const countdown = ref(0)
const testCode = ref('')  // æµ‹è¯•æ¨¡å¼ä¸‹æ˜¾ç¤ºçš„éªŒè¯ç 

// å€’è®¡æ—¶
let countdownTimer: number | null = null
const startCountdown = (seconds: number) => {
  countdown.value = seconds
  countdownTimer = window.setInterval(() => {
    countdown.value--
    if (countdown.value <= 0) {
      if (countdownTimer) {
        clearInterval(countdownTimer)
        countdownTimer = null
      }
    }
  }, 1000)
}

// å‘é€éªŒè¯ç 
const handleSendCode = async () => {
  // éªŒè¯é‚®ç®±
  try {
    await formRef.value?.validateField('email')
  } catch {
    return
  }

  codeButtonDisabled.value = true

  try {
    const response = await sendVerificationCode(form.email)
    
    if (response.success) {
      ElMessage.success(response.message || 'éªŒè¯ç å·²å‘é€')
      
      // æµ‹è¯•æ¨¡å¼ä¸‹æ˜¾ç¤ºéªŒè¯ç 
      if (response.code) {
        testCode.value = response.code
      }
      
      // å¯åŠ¨60ç§’å€’è®¡æ—¶ï¼ˆ1åˆ†é’Ÿé™åˆ¶ï¼‰
      startCountdown(60)
    }
  } catch (error: any) {
    if (error.message.includes('é¢‘ç¹')) {
      // é¢‘ç‡é™åˆ¶ï¼Œæ˜¾ç¤ºå‰©ä½™æ—¶é—´
      ElMessage.warning(error.message)
      
      // å¦‚æœè¿”å›äº†å‰©ä½™ç§’æ•°ï¼Œå¯åŠ¨å¯¹åº”å€’è®¡æ—¶
      // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…é”™è¯¯å“åº”è§£æ cooldown_seconds
      startCountdown(60)
    } else {
      ElMessage.error(error.message || 'å‘é€éªŒè¯ç å¤±è´¥')
    }
  } finally {
    codeButtonDisabled.value = false
  }
}

// æ³¨å†Œ
const handleRegister = async () => {
  try {
    await formRef.value?.validate()
  } catch {
    return
  }

  loading.value = true

  try {
    const response = await register(
      form.email,
      form.password,
      form.verificationCode
    )

    if (response.success) {
      ElMessage.success('æ³¨å†ŒæˆåŠŸï¼')
      
      // è·³è½¬åˆ°ç™»å½•é¡µé¢æˆ–æ‰§è¡Œå…¶ä»–æ“ä½œ
      console.log('æ³¨å†ŒæˆåŠŸï¼Œç”¨æˆ·ä¿¡æ¯:', response.data)
      
      // é‡ç½®è¡¨å•
      handleReset()
    }
  } catch (error: any) {
    ElMessage.error(error.message || 'æ³¨å†Œå¤±è´¥')
  } finally {
    loading.value = false
  }
}

// é‡ç½®è¡¨å•
const handleReset = () => {
  formRef.value?.resetFields()
  testCode.value = ''
  countdown.value = 0
  if (countdownTimer) {
    clearInterval(countdownTimer)
    countdownTimer = null
  }
}
</script>

<style scoped>
.register-form {
  max-width: 500px;
  margin: 0 auto;
  padding: 20px;
}
</style>
```

---

## ğŸ”§ åç«¯ CORS é…ç½®æ£€æŸ¥

ç¡®ä¿åç«¯å·²æ­£ç¡®é…ç½® CORSï¼Œå…è®¸å‰ç«¯åŸŸåè®¿é—®ã€‚

**å½“å‰é…ç½®**ï¼ˆ`config.py`ï¼‰:
```python
CORS_ORIGINS = os.environ.get('CORS_ORIGINS', 'http://localhost:5173,http://localhost:3000').split(',')
```

**å¦‚æœä½ çš„å‰ç«¯è¿è¡Œåœ¨å…¶ä»–ç«¯å£**ï¼Œéœ€è¦ä¿®æ”¹ï¼š

1. åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š
```env
CORS_ORIGINS=http://localhost:5173,http://localhost:3000,http://localhost:8080
```

2. æˆ–ç›´æ¥åœ¨ `config.py` ä¸­ä¿®æ”¹é»˜è®¤å€¼ã€‚

---

## ğŸ“ å®Œæ•´æ³¨å†Œæµç¨‹

### æ­¥éª¤ 1: ç”¨æˆ·è¾“å…¥é‚®ç®±

ç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥é‚®ç®±åœ°å€ã€‚

### æ­¥éª¤ 2: ç‚¹å‡»å‘é€éªŒè¯ç 

å‰ç«¯è°ƒç”¨ `/api/send-verification-code` æ¥å£ã€‚

**å¤„ç†é€»è¾‘**:
- âœ… æˆåŠŸï¼šæ˜¾ç¤º"éªŒè¯ç å·²å‘é€"æç¤ºï¼Œå¯åŠ¨60ç§’å€’è®¡æ—¶
- âŒ é¢‘ç‡é™åˆ¶ï¼ˆ429ï¼‰ï¼šæ˜¾ç¤ºå‰©ä½™ç­‰å¾…æ—¶é—´ï¼Œå¯åŠ¨å¯¹åº”å€’è®¡æ—¶
- âŒ å…¶ä»–é”™è¯¯ï¼šæ˜¾ç¤ºé”™è¯¯æç¤º

### æ­¥éª¤ 3: ç”¨æˆ·è¾“å…¥éªŒè¯ç 

ç”¨æˆ·è¾“å…¥æ”¶åˆ°çš„éªŒè¯ç ï¼ˆæµ‹è¯•æ¨¡å¼ä¸‹ï¼ŒéªŒè¯ç ä¼šæ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šï¼‰ã€‚

### æ­¥éª¤ 4: å¡«å†™å¯†ç å¹¶æäº¤æ³¨å†Œ

å‰ç«¯è°ƒç”¨ `/api/register` æ¥å£ã€‚

**å¤„ç†é€»è¾‘**:
- âœ… æˆåŠŸï¼šæ˜¾ç¤º"æ³¨å†ŒæˆåŠŸ"æç¤ºï¼Œè·³è½¬æˆ–æ‰§è¡Œåç»­æ“ä½œ
- âŒ éªŒè¯ç é”™è¯¯ï¼šæç¤ºç”¨æˆ·æ£€æŸ¥éªŒè¯ç 
- âŒ éªŒè¯ç è¿‡æœŸï¼šæç¤ºç”¨æˆ·é‡æ–°è·å–éªŒè¯ç 
- âŒ é‚®ç®±å·²å­˜åœ¨ï¼šæç¤ºç”¨æˆ·è¯¥é‚®ç®±å·²æ³¨å†Œ
- âŒ å…¶ä»–é”™è¯¯ï¼šæ˜¾ç¤ºé”™è¯¯æç¤º

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
python app.py
```

åç«¯åº”è¯¥åœ¨ `http://localhost:5000` å¯åŠ¨ã€‚

### 2. æµ‹è¯•æ¥å£è¿é€šæ€§

åœ¨æµè§ˆå™¨æ§åˆ¶å°æˆ–ä½¿ç”¨ Postman æµ‹è¯•ï¼š

```javascript
// æµ‹è¯•å‘é€éªŒè¯ç 
fetch('http://localhost:5000/api/send-verification-code', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email: 'test@example.com' })
})
.then(res => res.json())
.then(data => console.log(data))
```

### 3. å‰ç«¯è°ƒç”¨æµ‹è¯•

åœ¨å‰ç«¯é¡¹ç›®ä¸­å¼•å…¥ API å‡½æ•°å¹¶è°ƒç”¨ã€‚

---

## âš ï¸ å¸¸è§é—®é¢˜

### 1. CORS è·¨åŸŸé”™è¯¯

**é”™è¯¯ä¿¡æ¯**: `Access-Control-Allow-Origin` é”™è¯¯

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥åç«¯ CORS é…ç½®æ˜¯å¦åŒ…å«å‰ç«¯åœ°å€
- ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ

### 2. ç½‘ç»œé”™è¯¯

**é”™è¯¯ä¿¡æ¯**: `Failed to fetch` æˆ– `Network Error`

**è§£å†³æ–¹æ³•**:
- ç¡®è®¤åç«¯æœåŠ¡å·²å¯åŠ¨
- æ£€æŸ¥åç«¯åœ°å€æ˜¯å¦æ­£ç¡®ï¼ˆ`http://localhost:5000`ï¼‰
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### 3. éªŒè¯ç é¢‘ç‡é™åˆ¶

**è¡¨ç°**: è¿ç»­å‘é€ä¸¤æ¬¡éªŒè¯ç ï¼Œç¬¬äºŒæ¬¡è¿”å› 429 é”™è¯¯

**å¤„ç†æ–¹å¼**: 
- å‰ç«¯æ˜¾ç¤ºå€’è®¡æ—¶
- åœ¨å€’è®¡æ—¶æœŸé—´ç¦ç”¨å‘é€æŒ‰é’®

### 4. éªŒè¯ç è¿‡æœŸ

**è¡¨ç°**: ç­‰å¾…è¶…è¿‡10åˆ†é’Ÿåæ³¨å†Œï¼Œè¿”å›éªŒè¯ç è¿‡æœŸé”™è¯¯

**å¤„ç†æ–¹å¼**:
- æç¤ºç”¨æˆ·é‡æ–°è·å–éªŒè¯ç 
- æ¸…é™¤å·²è¾“å…¥çš„éªŒè¯ç 

---

## ğŸ“¦ æä¾›æ–‡ä»¶æ¸…å•

æä¾›ç»™å‰ç«¯çš„æ–‡ä»¶ï¼š

1. âœ… **API æ¥å£æ–‡æ¡£**ï¼ˆæœ¬æ–‡æ¡£ï¼‰
2. âœ… **TypeScript ç±»å‹å®šä¹‰**ï¼ˆä»£ç ç¤ºä¾‹ä¸­å·²åŒ…å«ï¼‰
3. âœ… **API è°ƒç”¨å‡½æ•°**ï¼ˆ`src/api/auth.ts` ç¤ºä¾‹ä»£ç ï¼‰
4. âœ… **Vue ç»„ä»¶ç¤ºä¾‹**ï¼ˆ`RegisterForm.vue` ç¤ºä¾‹ä»£ç ï¼‰

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [å®Œæ•´ API æ–‡æ¡£](./API.md)
- [åŠŸèƒ½æ›´æ–°è¯´æ˜](./åŠŸèƒ½æ›´æ–°è¯´æ˜.md)

---

**æœ¬åœ°å¼€å‘è”è°ƒæ—¶ï¼Œç¡®ä¿åç«¯è¿è¡Œåœ¨ `http://localhost:5000`** ğŸš€

