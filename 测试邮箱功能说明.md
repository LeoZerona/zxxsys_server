# 邮箱验证码功能测试指南

## 测试方式概览

有多种方式可以测试邮箱发送验证码功能：

1. **Python 测试脚本**（推荐，最简单）
2. **使用 curl 命令**
3. **使用 Postman 或其他 API 工具**
4. **运行单元测试**
5. **前端调用示例**

---

## 方法 1: 使用 Python 测试脚本（推荐）

### 步骤 1: 启动 Flask 应用

在一个终端窗口运行：

```bash
python app.py
```

应用会在 `http://localhost:5000` 启动。

### 步骤 2: 运行测试脚本

在另一个终端窗口运行：

```bash
python test_email_api.py
```

脚本会提示你输入邮箱，然后自动测试：
- 发送验证码
- 验证验证码
- 测试无效邮箱
- 测试无效验证码

### 示例输出

```
============================================================
邮箱验证码功能测试
============================================================

提示:
1. 确保 Flask 应用正在运行 (python app.py)
2. 如果没有配置真实邮箱，验证码会打印到控制台（测试模式）
3. 测试模式下，API 会返回验证码，方便测试

请输入测试邮箱 [默认: test@example.com]: 

============================================================
开始测试...
============================================================

============================================================
测试发送验证码
============================================================

请求 URL: http://localhost:5000/api/send-verification-code
请求数据: {
  "email": "test@example.com"
}

响应状态码: 200
响应内容:
{
  "success": true,
  "message": "验证码已发送",
  "code": "123456"
}

✓ 发送验证码成功！
验证码: 123456 (测试模式返回的验证码)
```

---

## 方法 2: 使用 curl 命令

### 发送验证码

```bash
curl -X POST http://localhost:5000/api/send-verification-code \
  -H "Content-Type: application/json" \
  -d "{\"email\": \"test@example.com\"}"
```

### 验证验证码

```bash
curl -X POST http://localhost:5000/api/verify-code \
  -H "Content-Type: application/json" \
  -d "{\"email\": \"test@example.com\", \"code\": \"123456\"}"
```

### Windows PowerShell 版本

```powershell
# 发送验证码
Invoke-RestMethod -Uri "http://localhost:5000/api/send-verification-code" `
  -Method Post `
  -ContentType "application/json" `
  -Body '{"email": "test@example.com"}'

# 验证验证码
Invoke-RestMethod -Uri "http://localhost:5000/api/verify-code" `
  -Method Post `
  -ContentType "application/json" `
  -Body '{"email": "test@example.com", "code": "123456"}'
```

---

## 方法 3: 使用 Postman

### 发送验证码

1. **方法**: POST
2. **URL**: `http://localhost:5000/api/send-verification-code`
3. **Headers**:
   - `Content-Type: application/json`
4. **Body** (raw JSON):
   ```json
   {
     "email": "test@example.com"
   }
   ```

### 验证验证码

1. **方法**: POST
2. **URL**: `http://localhost:5000/api/verify-code`
3. **Headers**:
   - `Content-Type: application/json`
4. **Body** (raw JSON):
   ```json
   {
     "email": "test@example.com",
     "code": "123456"
   }
   ```

---

## 方法 4: 运行单元测试

### 运行所有测试

```bash
pytest
```

### 只测试邮箱功能

```bash
# 测试邮箱服务
pytest tests/test_email_service.py

# 测试邮箱 API
pytest tests/test_api.py::TestEmailVerificationAPI
```

### 查看详细输出

```bash
pytest tests/test_email_service.py -v
```

---

## 方法 5: 前端调用示例

### JavaScript/TypeScript (Fetch API)

```javascript
// 发送验证码
async function sendVerificationCode(email) {
  const response = await fetch('http://localhost:5000/api/send-verification-code', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      email: email
    })
  });
  
  const data = await response.json();
  console.log('发送结果:', data);
  
  if (data.success) {
    // 测试模式下，验证码会包含在响应中
    if (data.code) {
      console.log('验证码:', data.code);
    }
    return data;
  } else {
    throw new Error(data.message);
  }
}

// 验证验证码
async function verifyCode(email, code) {
  const response = await fetch('http://localhost:5000/api/verify-code', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      email: email,
      code: code
    })
  });
  
  const data = await response.json();
  console.log('验证结果:', data);
  return data;
}

// 使用示例
(async () => {
  try {
    // 发送验证码
    const sendResult = await sendVerificationCode('test@example.com');
    
    // 等待用户输入验证码
    const code = prompt('请输入验证码:');
    
    // 验证验证码
    const verifyResult = await verifyCode('test@example.com', code);
    
    if (verifyResult.success) {
      console.log('验证成功！');
    }
  } catch (error) {
    console.error('错误:', error);
  }
})();
```

### Vue 3 组件示例

```vue
<template>
  <div>
    <input v-model="email" type="email" placeholder="邮箱" />
    <button @click="sendCode" :disabled="loading">发送验证码</button>
    
    <div v-if="codeSent">
      <input v-model="code" type="text" placeholder="验证码" />
      <button @click="verifyCode" :disabled="loading">验证</button>
    </div>
    
    <p v-if="message">{{ message }}</p>
  </div>
</template>

<script setup>
import { ref } from 'vue'

const email = ref('')
const code = ref('')
const codeSent = ref(false)
const loading = ref(false)
const message = ref('')

async function sendCode() {
  loading.value = true
  message.value = ''
  
  try {
    const response = await fetch('http://localhost:5000/api/send-verification-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email.value })
    })
    
    const data = await response.json()
    
    if (data.success) {
      message.value = '验证码已发送！'
      codeSent.value = true
      
      // 测试模式下显示验证码
      if (data.code) {
        message.value += ` 验证码: ${data.code}`
      }
    } else {
      message.value = data.message
    }
  } catch (error) {
    message.value = '发送失败: ' + error.message
  } finally {
    loading.value = false
  }
}

async function verifyCode() {
  loading.value = true
  message.value = ''
  
  try {
    const response = await fetch('http://localhost:5000/api/verify-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: email.value,
        code: code.value
      })
    })
    
    const data = await response.json()
    message.value = data.message
    
    if (data.success) {
      // 验证成功，可以继续下一步操作
      console.log('验证成功！')
    }
  } catch (error) {
    message.value = '验证失败: ' + error.message
  } finally {
    loading.value = false
  }
}
</script>
```

---

## 测试模式说明

### 测试模式（默认）

如果没有配置真实邮箱服务，系统会以**测试模式**运行：

1. **验证码会打印到 Flask 应用的控制台**
2. **API 响应中会包含验证码**（方便测试）
3. **不会发送真实邮件**

查看 Flask 应用控制台，你会看到：

```
[测试模式] 发送验证码到 test@example.com: 123456
```

### 真实邮件模式

要发送真实邮件，需要配置邮箱服务：

1. 创建 `.env` 文件：

```env
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-app-password
MAIL_DEFAULT_SENDER=your-email@gmail.com
```

2. 重启 Flask 应用

3. 现在验证码会发送到真实邮箱，API 响应中不会包含验证码

---

## 完整的测试流程

### 1. 启动服务

```bash
python app.py
```

### 2. 发送验证码

```bash
python test_email_api.py
```

或者使用 curl：

```bash
curl -X POST http://localhost:5000/api/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com"}'
```

### 3. 查看验证码

- **测试模式**: 查看 Flask 应用控制台或 API 响应
- **真实邮件模式**: 查看邮箱收件箱

### 4. 验证验证码

```bash
curl -X POST http://localhost:5000/api/verify-code \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "code": "123456"}'
```

---

## 常见问题

### Q: 提示连接失败？

**A**: 确保 Flask 应用正在运行：
```bash
python app.py
```

### Q: 验证码在哪里查看？

**A**: 
- 测试模式：Flask 应用控制台或 API 响应中的 `code` 字段
- 真实邮件模式：邮箱收件箱

### Q: 如何配置真实邮箱？

**A**: 查看 `config.py` 中的邮箱配置，或创建 `.env` 文件配置邮箱服务。

### Q: 验证码有效期多久？

**A**: 默认 10 分钟，可在 `config.py` 中修改 `VERIFICATION_CODE_EXPIRE_MINUTES`。

---

## 快速开始

最简单的测试方式：

```bash
# 终端 1: 启动 Flask
python app.py

# 终端 2: 运行测试脚本
python test_email_api.py
```

就这么简单！

