# 验证码功能测试用例说明

## 📋 测试脚本

已创建以下测试脚本：

### 1. `test_send_verification_code.py` - 完整功能测试 ⭐推荐

**功能**：全面测试验证码发送和验证的所有功能

**包含测试**：
- ✅ 成功发送验证码
- ✅ 成功验证验证码
- ✅ 验证无效验证码（应该拒绝）
- ✅ 无效邮箱格式（应该拒绝）
- ✅ 空邮箱（应该拒绝）
- ✅ 重新发送验证码（更新验证码）

**使用方法**：
```bash
python test_send_verification_code.py
```

**特点**：
- 交互式输入测试邮箱
- 详细的测试输出
- 自动生成测试报告
- 显示通过率和失败原因

---

### 2. `test_verification_code_integration.py` - 集成测试

**功能**：测试完整的验证码流程

**包含测试**：
- 完整流程：发送验证码 → 验证验证码
- 错误情况：各种错误输入的处理

**使用方法**：
```bash
python test_verification_code_integration.py
```

---

### 3. `test_email_api.py` - 基础 API 测试

**功能**：基础的 API 接口测试

**使用方法**：
```bash
python test_email_api.py
```

---

### 4. 单元测试（pytest）

**位置**：`tests/` 目录

**包含文件**：
- `tests/test_email_service.py` - 邮箱服务单元测试
- `tests/test_api.py` - API 接口单元测试

**使用方法**：
```bash
# 运行所有测试
pytest

# 只测试邮箱功能
pytest tests/test_email_service.py -v
pytest tests/test_api.py::TestEmailVerificationAPI -v
```

---

## 🚀 快速开始

### 步骤 1: 启动 Flask 应用

在一个终端窗口运行：

```bash
python app.py
```

应用会在 `http://localhost:5000` 启动。

### 步骤 2: 运行测试

在另一个终端窗口运行：

```bash
# 推荐：完整功能测试
python test_send_verification_code.py

# 或：集成测试
python test_verification_code_integration.py
```

---

## 📊 测试用例详情

### 测试用例 1: 发送验证码（成功）

**目的**：验证能够成功发送验证码

**步骤**：
1. 发送 POST 请求到 `/api/send-verification-code`
2. 传递有效的邮箱地址
3. 检查响应状态码是否为 200
4. 检查响应中 `success` 是否为 `true`
5. 检查数据库中是否保存了验证码

**预期结果**：
- ✅ 状态码：200
- ✅ 响应包含 `success: true`
- ✅ 数据库中保存了验证码记录
- ✅ 验证码为 6 位数字
- ✅ 验证码未过期
- ✅ 验证码未使用

---

### 测试用例 2: 验证验证码（成功）

**目的**：验证能够成功验证正确的验证码

**前置条件**：已通过测试用例 1 获取验证码

**步骤**：
1. 发送 POST 请求到 `/api/verify-code`
2. 传递邮箱和验证码
3. 检查响应状态码是否为 200
4. 检查响应中 `success` 是否为 `true`
5. 检查数据库中验证码是否标记为已使用

**预期结果**：
- ✅ 状态码：200
- ✅ 响应包含 `success: true`
- ✅ 数据库中的验证码标记为 `is_used = true`

---

### 测试用例 3: 验证无效验证码

**目的**：验证系统能够拒绝错误的验证码

**步骤**：
1. 发送 POST 请求到 `/api/verify-code`
2. 传递错误的验证码（如 "000000"）
3. 检查响应状态码是否为 400
4. 检查响应中 `success` 是否为 `false`

**预期结果**：
- ✅ 状态码：400
- ✅ 响应包含 `success: false`
- ✅ 错误消息提示验证码无效

---

### 测试用例 4: 发送验证码到无效邮箱

**目的**：验证系统能够拒绝无效的邮箱格式

**步骤**：
1. 发送 POST 请求到 `/api/send-verification-code`
2. 传递无效的邮箱格式（如 "invalid-email"）
3. 检查响应状态码是否为 400
4. 检查响应中 `success` 是否为 `false`

**预期结果**：
- ✅ 状态码：400
- ✅ 响应包含 `success: false`
- ✅ 错误消息提示邮箱格式不正确

---

### 测试用例 5: 发送验证码到空邮箱

**目的**：验证系统能够拒绝空邮箱

**步骤**：
1. 发送 POST 请求到 `/api/send-verification-code`
2. 传递空字符串作为邮箱
3. 检查响应状态码是否为 400

**预期结果**：
- ✅ 状态码：400
- ✅ 响应包含 `success: false`
- ✅ 错误消息提示邮箱不能为空

---

### 测试用例 6: 重新发送验证码

**目的**：验证对同一邮箱重新发送验证码时，会更新而不是创建新记录

**步骤**：
1. 向同一邮箱发送第一次验证码
2. 立即向同一邮箱发送第二次验证码
3. 检查两次验证码是否不同
4. 检查数据库中是否只有一条记录

**预期结果**：
- ✅ 两次验证码不同
- ✅ 数据库中只有一条记录（被更新）
- ✅ 验证码记录被重置为未使用状态

---

## 🧪 单元测试用例

### 邮箱服务单元测试 (`tests/test_email_service.py`)

1. **test_generate_verification_code** - 测试验证码生成
2. **test_send_verification_code** - 测试发送验证码
3. **test_send_verification_code_updates_existing** - 测试更新已存在的验证码
4. **test_verify_code_success** - 测试验证码验证成功
5. **test_verify_code_invalid** - 测试无效验证码
6. **test_verify_code_expired** - 测试过期验证码
7. **test_verify_code_already_used** - 测试已使用的验证码

### API 接口单元测试 (`tests/test_api.py`)

1. **test_send_verification_code** - 测试发送验证码 API
2. **test_send_code_invalid_email** - 测试无效邮箱 API
3. **test_verify_code_success** - 测试验证验证码 API（成功）
4. **test_verify_code_invalid** - 测试验证验证码 API（失败）

---

## 📈 测试报告示例

运行 `test_send_verification_code.py` 会生成如下报告：

```
======================================================================
  测试总结
======================================================================

📊 测试结果:
----------------------------------------------------------------------
  ✅ 通过  - 发送验证码
  ✅ 通过  - 验证正确验证码
  ✅ 通过  - 验证无效验证码
  ✅ 通过  - 重新发送验证码
  ✅ 通过  - 无效邮箱格式
  ✅ 通过  - 空邮箱
----------------------------------------------------------------------

📈 总计: 6 个测试
✅ 通过: 6 个
❌ 失败: 0 个
📊 通过率: 100.0%

======================================================================
  🎉 所有测试通过！
======================================================================
```

---

## ⚠️ 注意事项

1. **Flask 应用必须运行**
   - 测试前确保 `python app.py` 正在运行
   - 应用应在 `http://localhost:5000`

2. **测试模式 vs 真实邮件**
   - 如果未配置真实邮箱，会使用测试模式
   - 测试模式下，验证码会打印到控制台
   - 测试模式下，API 响应会包含验证码

3. **数据库**
   - 测试会向数据库写入验证码记录
   - 使用测试数据库时，测试完成后会自动清理
   - 使用生产数据库时，注意测试数据

4. **并发测试**
   - 多个测试脚本可以同时运行
   - 注意避免使用相同的测试邮箱

---

## 🔍 故障排除

### 问题：连接失败

**错误**：`ConnectionError` 或 `连接失败`

**解决方法**：
1. 确保 Flask 应用正在运行
2. 检查应用是否在 `http://localhost:5000`
3. 检查防火墙设置

### 问题：验证码验证失败

**错误**：验证正确的验证码也失败

**解决方法**：
1. 检查数据库连接
2. 确认验证码未过期（10分钟有效期）
3. 确认验证码未被使用
4. 检查时区设置

### 问题：测试失败但功能正常

**可能原因**：
1. 测试环境与运行环境不同
2. 数据库状态不一致
3. 时间同步问题

**解决方法**：
1. 清理数据库后重新测试
2. 检查系统时间
3. 查看 Flask 应用日志

---

## 📚 相关文档

- [API 文档](API.md)
- [邮箱配置说明](邮箱配置说明-多邮箱.md)
- [测试文档](tests/README.md)

