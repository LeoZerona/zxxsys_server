# 数据库配置说明

## 📋 概述

项目支持两种数据库：**SQLite** 和 **MySQL**，可以通过简单配置进行切换。

---

## 🔧 配置方式

### 方式一：使用环境变量 DB_TYPE（推荐）

在项目根目录创建 `.env` 文件：

#### 使用 MySQL（默认）

```env
DB_TYPE=mysql
MYSQL_USER=root
MYSQL_PASSWORD=123456
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_DATABASE=test
```

#### 使用 SQLite

```env
DB_TYPE=sqlite
SQLITE_DB_PATH=app.db
```

### 方式二：直接设置 DATABASE_URL

```env
# MySQL
DATABASE_URL=mysql+pymysql://root:123456@localhost:3306/test?charset=utf8mb4

# SQLite
DATABASE_URL=sqlite:///app.db
```

### 方式三：使用环境变量（命令行）

#### Windows PowerShell

```powershell
# 使用 MySQL
$env:DB_TYPE="mysql"
$env:MYSQL_USER="root"
$env:MYSQL_PASSWORD="123456"

# 使用 SQLite
$env:DB_TYPE="sqlite"
```

#### Windows CMD

```cmd
# 使用 MySQL
set DB_TYPE=mysql
set MYSQL_USER=root
set MYSQL_PASSWORD=123456

# 使用 SQLite
set DB_TYPE=sqlite
```

---

## 📊 数据库配置详情

### MySQL 配置

| 环境变量 | 说明 | 默认值 |
|---------|------|--------|
| `DB_TYPE` | 数据库类型 | `mysql` |
| `MYSQL_USER` | MySQL 用户名 | `root` |
| `MYSQL_PASSWORD` | MySQL 密码 | `123456` |
| `MYSQL_HOST` | MySQL 主机 | `localhost` |
| `MYSQL_PORT` | MySQL 端口 | `3306` |
| `MYSQL_DATABASE` | 数据库名 | `test` |

**完整连接字符串格式**：
```
mysql+pymysql://用户名:密码@主机:端口/数据库名?charset=utf8mb4
```

### SQLite 配置

| 环境变量 | 说明 | 默认值 |
|---------|------|--------|
| `DB_TYPE` | 数据库类型 | `sqlite` |
| `SQLITE_DB_PATH` | 数据库文件路径 | `app.db` |

**完整连接字符串格式**：
```
sqlite:///数据库文件路径
```

---

## 🚀 快速切换

### 切换到 MySQL

1. **创建 `.env` 文件**：
```env
DB_TYPE=mysql
MYSQL_USER=root
MYSQL_PASSWORD=123456
MYSQL_DATABASE=test
```

2. **重启服务**：
```bash
python app.py
```

### 切换到 SQLite

1. **修改 `.env` 文件**：
```env
DB_TYPE=sqlite
SQLITE_DB_PATH=app.db
```

2. **重启服务**：
```bash
python app.py
```

---

## 💡 使用示例

### 示例 1: 开发环境使用 SQLite（快速测试）

`.env` 文件：
```env
DB_TYPE=sqlite
SQLITE_DB_PATH=app.db
```

优点：
- ✅ 无需安装 MySQL
- ✅ 数据库文件在项目中，易于管理
- ✅ 快速启动，适合开发测试

### 示例 2: 生产环境使用 MySQL

`.env` 文件：
```env
DB_TYPE=mysql
MYSQL_USER=root
MYSQL_PASSWORD=你的密码
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_DATABASE=production_db
```

优点：
- ✅ 性能更好
- ✅ 支持并发访问
- ✅ 适合生产环境

---

## 📝 配置优先级

配置按以下优先级生效：

1. **环境变量 `DATABASE_URL`**（最高优先级）
   - 如果设置了，直接使用，忽略其他配置
   
2. **环境变量 `DB_TYPE` + 相应配置**
   - 根据 `DB_TYPE` 选择 SQLite 或 MySQL
   - 使用对应的环境变量配置

3. **默认配置**
   - 如果没有设置任何环境变量，默认使用 **MySQL test 数据库**

---

## 🔍 验证配置

启动服务后，查看控制台输出：

### MySQL 配置示例输出

```
数据库类型: MySQL
   数据库: test
   用户: root@localhost
✅ 数据库连接正常
✅ 数据库表检查/创建完成
📊 当前用户数量: 0
```

### SQLite 配置示例输出

```
数据库类型: SQLite
   数据库文件: app.db
✅ 数据库连接正常
✅ 数据库表检查/创建完成
📊 当前用户数量: 8
```

---

## ⚠️ 注意事项

1. **切换数据库后需要重启服务**
   - 配置修改后必须重启 Flask 服务才能生效

2. **数据不会自动迁移**
   - SQLite 和 MySQL 的数据是独立的
   - 切换数据库后，之前的数据不会自动迁移

3. **确保数据库和表已创建**
   - MySQL：确保 `test` 数据库和 `users` 表已创建
   - SQLite：会在首次启动时自动创建数据库文件

4. **测试用例配置**
   - `tests/conftest.py` 和 `test_register_api.py` 已配置为使用 MySQL test 数据库
   - 如果需要修改，请更新相应文件的配置

---

## 📚 相关文件

- `config.py` - 数据库配置主文件
- `.env` - 环境变量配置文件（需要手动创建）
- `env.example` - 环境变量配置示例

---

**现在你可以通过简单的配置切换使用 SQLite 或 MySQL 了！** 🎉

