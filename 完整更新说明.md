# åŠŸèƒ½å®Œæ•´æ›´æ–°è¯´æ˜

## ğŸ“‹ æœ¬æ¬¡æ›´æ–°æ€»è§ˆ

### âœ… å·²å®Œæˆçš„åŠŸèƒ½æ›´æ–°

1. **ç”¨æˆ·æƒé™å­—æ®µ** - æ·»åŠ  role å­—æ®µï¼Œæ”¯æŒæƒé™ç®¡ç†
2. **éªŒè¯ç å‘é€é¢‘ç‡é™åˆ¶** - 1åˆ†é’Ÿå†…åªèƒ½è·å–ä¸€æ¬¡
3. **æ³¨å†Œæ—¶éªŒè¯ç éªŒè¯** - æ³¨å†Œå¿…é¡»æä¾›éªŒè¯ç ï¼Œå¹¶æ£€æŸ¥æ—¶æ•ˆæ€§
4. **å•†åŠ¡é£æ ¼é‚®ä»¶æ¨¡æ¿** - å†å­¦ä¹ æ•™è‚²å“ç‰Œé‚®ä»¶æ¨¡æ¿

---

## ğŸ”§ è¯¦ç»†æ›´æ–°å†…å®¹

### 1. ç”¨æˆ·æƒé™å­—æ®µ

#### å®ç°ä½ç½®
- `models.py` (ç¬¬ 16 è¡Œ) - User æ¨¡å‹æ–°å¢ `role` å­—æ®µ

#### æƒé™ç±»å‹
```python
- 'super_admin'  # è¶…çº§ç®¡ç†å‘˜ï¼ˆæœ€é«˜æƒé™ï¼‰
- 'admin'        # ç®¡ç†å‘˜
- 'user'         # æ™®é€šç”¨æˆ·ï¼ˆé»˜è®¤ï¼‰
```

#### æ–°å¢æ–¹æ³•
```python
# æ£€æŸ¥æƒé™
user.has_permission('admin')  # æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†å‘˜æƒé™

# å¿«æ·æ–¹æ³•
user.is_super_admin()  # æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜
user.is_admin()        # æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼ˆåŒ…æ‹¬è¶…çº§ç®¡ç†å‘˜ï¼‰
```

#### ä½¿ç”¨åœºæ™¯
- ç”¨äºåç»­è¿”å›èœå•æƒé™
- API æƒé™æ§åˆ¶
- å‰ç«¯èœå•æ˜¾ç¤ºæ§åˆ¶

---

### 2. éªŒè¯ç å‘é€é¢‘ç‡é™åˆ¶

#### åŠŸèƒ½è¯´æ˜
- **é™åˆ¶è§„åˆ™**ï¼šæ¯ä¸ªé‚®ç®± 1 åˆ†é’Ÿå†…åªèƒ½è·å–ä¸€æ¬¡éªŒè¯ç 
- **å®ç°ä½ç½®**ï¼š`email_service.py` - `send_verification_code()` å‡½æ•°

#### å“åº”ç¤ºä¾‹ï¼ˆé¢‘ç‡é™åˆ¶æ—¶ï¼‰
```json
{
  "success": false,
  "message": "å‘é€éªŒè¯ç è¿‡äºé¢‘ç¹ï¼Œè¯·ç­‰å¾… 30ç§’ åå†è¯•",
  "cooldown_seconds": 30
}
```

#### HTTP çŠ¶æ€ç 
- é¢‘ç‡é™åˆ¶æ—¶è¿”å›ï¼š`429 Too Many Requests`
- å…¶ä»–é”™è¯¯è¿”å›ï¼š`500 Internal Server Error`

#### é…ç½®
- `config.py` ä¸­çš„ `VERIFICATION_CODE_COOLDOWN_MINUTES = 1`

---

### 3. æ³¨å†Œæ—¶éªŒè¯ç éªŒè¯

#### åŠŸèƒ½è¯´æ˜
- æ³¨å†Œæ—¶å¿…é¡»æä¾›éªŒè¯ç 
- éªŒè¯ç å¿…é¡»æœ‰æ•ˆä¸”æœªä½¿ç”¨
- éªŒè¯ç å¿…é¡»åœ¨æœ‰æ•ˆæœŸå†…ï¼ˆ10åˆ†é’Ÿå†…ï¼‰

#### æ³¨å†Œæ¥å£å˜æ›´

**å˜æ›´å‰**ï¼š
```json
POST /api/register
{
  "email": "user@example.com",
  "password": "password123"
}
```

**å˜æ›´å**ï¼š
```json
POST /api/register
{
  "email": "user@example.com",
  "password": "password123",
  "verification_code": "123456"  // å¿…å¡«
}
```

#### é”™è¯¯å“åº”

- éªŒè¯ç ä¸ºç©ºï¼š
```json
{
  "success": false,
  "message": "éªŒè¯ç ä¸èƒ½ä¸ºç©º"
}
```

- éªŒè¯ç æ— æ•ˆï¼š
```json
{
  "success": false,
  "message": "éªŒè¯ç æ— æ•ˆ"
}
```

- éªŒè¯ç è¿‡æœŸï¼š
```json
{
  "success": false,
  "message": "éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–"
}
```

---

### 4. å•†åŠ¡é£æ ¼é‚®ä»¶æ¨¡æ¿

#### æ¨¡æ¿ç‰¹ç‚¹
- ä¸“ä¸šçš„å•†åŠ¡è®¾è®¡é£æ ¼
- ç´«è‰²æ¸å˜ä¸»é¢˜ï¼ˆ#667eea â†’ #764ba2ï¼‰
- å“åº”å¼å¸ƒå±€
- å“ç‰Œæ ‡è¯†ï¼šå†å­¦ä¹ æ•™è‚²
- å®‰å…¨æç¤ºåŒºåŸŸ

#### æ¨¡æ¿å†…å®¹
- å…¬å¸åç§°ï¼šå†å­¦ä¹ æ•™è‚²
- ä¸šåŠ¡å®šä½ï¼šä¸“ä¸šæˆäººè‡ªè€ƒæ•™è‚²å¹³å°
- éªŒè¯ç çªå‡ºæ˜¾ç¤º
- æœ‰æ•ˆæœŸæé†’

---

## ğŸ“Š æ•°æ®åº“å˜æ›´

### users è¡¨æ–°å¢å­—æ®µ

```sql
ALTER TABLE users ADD COLUMN role VARCHAR(20) DEFAULT 'user' NOT NULL;
CREATE INDEX idx_users_role ON users(role);
```

### è¿ç§»æ­¥éª¤

**æ–¹å¼ 1: ä½¿ç”¨ SQLï¼ˆæ¨èï¼‰**
```bash
sqlite3 app.db < update_users_table_add_role.sql
```

**æ–¹å¼ 2: é‡æ–°åˆ›å»ºè¡¨ï¼ˆæ–°é¡¹ç›®ï¼‰**
```bash
python init_db.py
```

**æ–¹å¼ 3: ä½¿ç”¨è¿ç§»è„šæœ¬**
```bash
python migrate_add_user_role.py
```

---

## ğŸ§ª æµ‹è¯•æ›´æ–°

### æ–°å¢æµ‹è¯•æ–‡ä»¶
- `tests/test_frequency_limit.py` - é¢‘ç‡é™åˆ¶æµ‹è¯•

### æ›´æ–°çš„æµ‹è¯•
- `tests/test_api.py` - æ›´æ–°æ³¨å†Œæµ‹è¯•ï¼Œæ·»åŠ éªŒè¯ç å‚æ•°

### æµ‹è¯•å†…å®¹
1. âœ… éªŒè¯ç å‘é€é¢‘ç‡é™åˆ¶
2. âœ… æ³¨å†Œæ—¶éªŒè¯ç éªŒè¯
3. âœ… éªŒè¯ç æ—¶æ•ˆæ€§æ£€æŸ¥
4. âœ… ç”¨æˆ·æƒé™å­—æ®µ

---

## ğŸ“ API å˜æ›´æ±‡æ€»

### æ³¨å†Œæ¥å£ (`POST /api/register`)

**æ–°å¢å¿…å¡«å‚æ•°**ï¼š
- `verification_code` (string, required) - é‚®ç®±éªŒè¯ç 

**å“åº”æ–°å¢å­—æ®µ**ï¼š
- `data.role` - ç”¨æˆ·æƒé™ï¼ˆé»˜è®¤ï¼š'user'ï¼‰

### å‘é€éªŒè¯ç æ¥å£ (`POST /api/send-verification-code`)

**æ–°å¢é™åˆ¶**ï¼š
- é¢‘ç‡é™åˆ¶ï¼š1 åˆ†é’Ÿå†…åªèƒ½å‘é€ä¸€æ¬¡
- è¿”å›çŠ¶æ€ç ï¼š429ï¼ˆé¢‘ç‡é™åˆ¶æ—¶ï¼‰

**å“åº”æ–°å¢å­—æ®µï¼ˆé¢‘ç‡é™åˆ¶æ—¶ï¼‰**ï¼š
- `cooldown_seconds` - å‰©ä½™ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰

---

## ğŸš€ ä½¿ç”¨æµç¨‹

### å®Œæ•´æ³¨å†Œæµç¨‹

1. **å‘é€éªŒè¯ç **
```bash
POST /api/send-verification-code
{
  "email": "user@example.com"
}
```

2. **ç­‰å¾…éªŒè¯ç **ï¼ˆæŸ¥çœ‹é‚®ç®±æˆ–æµ‹è¯•æ¨¡å¼ä¸‹çš„å“åº”ï¼‰

3. **æ³¨å†Œè´¦æˆ·**
```bash
POST /api/register
{
  "email": "user@example.com",
  "password": "password123",
  "verification_code": "123456"
}
```

### Vue3 å®Œæ•´ç¤ºä¾‹

```typescript
// 1. å‘é€éªŒè¯ç 
const sendCode = async (email: string) => {
  const response = await fetch('/api/send-verification-code', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email })
  });
  
  const data = await response.json();
  
  if (!data.success) {
    if (response.status === 429) {
      // é¢‘ç‡é™åˆ¶
      console.log(`è¯·ç­‰å¾… ${data.cooldown_seconds} ç§’åå†è¯•`);
    }
    throw new Error(data.message);
  }
  
  return data;
};

// 2. æ³¨å†Œ
const register = async (email: string, password: string, code: string) => {
  const response = await fetch('/api/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email,
      password,
      verification_code: code
    })
  });
  
  const data = await response.json();
  
  if (!data.success) {
    throw new Error(data.message);
  }
  
  return data;
};

// ä½¿ç”¨
async function handleRegister(email: string, password: string) {
  // å‘é€éªŒè¯ç 
  await sendCode(email);
  
  // ç”¨æˆ·è¾“å…¥éªŒè¯ç 
  const code = prompt('è¯·è¾“å…¥éªŒè¯ç :');
  
  // æ³¨å†Œ
  const result = await register(email, password, code);
  console.log('æ³¨å†ŒæˆåŠŸ:', result.data);
}
```

---

## âš ï¸ é‡è¦æç¤º

### 1. æ•°æ®åº“è¿ç§»

**å¦‚æœå·²æœ‰ users è¡¨ï¼Œå¿…é¡»æ‰§è¡Œè¿ç§»**ï¼š
```sql
ALTER TABLE users ADD COLUMN role VARCHAR(20) DEFAULT 'user' NOT NULL;
CREATE INDEX idx_users_role ON users(role);
```

### 2. å‰ç«¯å…¼å®¹æ€§

**æ³¨å†Œæ¥å£å·²å˜æ›´**ï¼š
- âŒ æ—§ç‰ˆæœ¬ï¼šä¸éœ€è¦éªŒè¯ç 
- âœ… æ–°ç‰ˆæœ¬ï¼šå¿…é¡»æä¾›éªŒè¯ç 

**å‰ç«¯éœ€è¦æ›´æ–°**ï¼š
1. æ³¨å†Œæµç¨‹éœ€è¦å…ˆå‘é€éªŒè¯ç 
2. æ³¨å†Œæ—¶ä¼ é€’éªŒè¯ç å‚æ•°
3. å¤„ç†é¢‘ç‡é™åˆ¶æç¤ºï¼ˆ429 çŠ¶æ€ç ï¼‰

### 3. æƒé™ç®¡ç†

**æ–°ç”¨æˆ·é»˜è®¤æƒé™**ï¼š
- æ‰€æœ‰æ–°æ³¨å†Œç”¨æˆ·é»˜è®¤ä¸º `user`ï¼ˆæ™®é€šç”¨æˆ·ï¼‰
- éœ€è¦é€šè¿‡ç®¡ç†æ¥å£ä¿®æ”¹æƒé™

**åç»­å¼€å‘å»ºè®®**ï¼š
- åˆ›å»ºç®¡ç†å‘˜æ¥å£ï¼ˆä¿®æ”¹ç”¨æˆ·æƒé™ï¼‰
- å®ç°åŸºäºæƒé™çš„èœå•æ¥å£
- æ·»åŠ æƒé™ä¸­é—´ä»¶

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶
- `models.py` - ç”¨æˆ·æ¨¡å‹ï¼ˆæ·»åŠ  role å­—æ®µï¼‰
- `app.py` - æ³¨å†Œæ¥å£ï¼ˆæ·»åŠ éªŒè¯ç éªŒè¯ï¼‰
- `email_service.py` - éªŒè¯ç æœåŠ¡ï¼ˆæ·»åŠ é¢‘ç‡é™åˆ¶ï¼‰
- `config.py` - é…ç½®ï¼ˆæ·»åŠ æƒé™å’Œé¢‘ç‡é…ç½®ï¼‰

### æ•°æ®åº“æ–‡ä»¶
- `update_users_table_add_role.sql` - æ•°æ®åº“è¿ç§» SQL
- `migrate_add_user_role.py` - è¿ç§»è„šæœ¬
- `create_users_table_only.sql` - æ›´æ–°åçš„è¡¨ç»“æ„

### æµ‹è¯•æ–‡ä»¶
- `tests/test_frequency_limit.py` - é¢‘ç‡é™åˆ¶æµ‹è¯•
- `tests/test_api.py` - æ›´æ–°åçš„ API æµ‹è¯•

### æ–‡æ¡£æ–‡ä»¶
- `API.md` - æ›´æ–°åçš„ API æ–‡æ¡£
- `åŠŸèƒ½æ›´æ–°è¯´æ˜.md` - åŠŸèƒ½æ›´æ–°è¯´æ˜
- `å®Œæ•´æ›´æ–°è¯´æ˜.md` - æœ¬æ–‡æ¡£

---

## âœ… éªŒè¯æ­¥éª¤

### 1. éªŒè¯æƒé™å­—æ®µ

```python
# æ£€æŸ¥ç”¨æˆ·æƒé™
user = User.query.first()
print(user.role)  # åº”è¯¥æ˜¾ç¤º 'user'
print(user.has_permission('admin'))  # åº”è¯¥è¿”å› False
```

### 2. éªŒè¯é¢‘ç‡é™åˆ¶

```bash
# è¿ç»­å‘é€ä¸¤æ¬¡éªŒè¯ç 
curl -X POST http://localhost:5000/api/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com"}'

# ç«‹å³å†æ¬¡å‘é€ï¼ˆåº”è¯¥è¿”å› 429ï¼‰
curl -X POST http://localhost:5000/api/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com"}'
```

### 3. éªŒè¯æ³¨å†Œæµç¨‹

```bash
# 1. å‘é€éªŒè¯ç 
curl -X POST http://localhost:5000/api/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{"email": "newuser@example.com"}'

# 2. æ³¨å†Œï¼ˆä½¿ç”¨è¿”å›çš„éªŒè¯ç ï¼‰
curl -X POST http://localhost:5000/api/register \
  -H "Content-Type: application/json" \
  -d '{"email": "newuser@example.com", "password": "password123", "verification_code": "123456"}'
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

1. **æƒé™ç®¡ç†æ¥å£**
   - ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·æƒé™
   - è·å–ç”¨æˆ·æƒé™åˆ—è¡¨

2. **èœå•æƒé™æ¥å£**
   - æ ¹æ®ç”¨æˆ·æƒé™è¿”å›èœå•
   - æƒé™æ ‘å½¢ç»“æ„

3. **JWT è®¤è¯**
   - ç™»å½•æ¥å£
   - Token ä¸­åŒ…å«æƒé™ä¿¡æ¯

4. **æ—¥å¿—è®°å½•**
   - è®°å½•éªŒè¯ç å‘é€
   - è®°å½•æ³¨å†Œæ“ä½œ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ•°æ®åº“è¿ç§»æ˜¯å¦æˆåŠŸ
2. é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®
3. Flask åº”ç”¨æ—¥å¿—
4. æµ‹è¯•è„šæœ¬è¾“å‡º

---

**æ‰€æœ‰åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼** ğŸ‰

